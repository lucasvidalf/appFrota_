<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DM — PDN (Gerenciar + Disponibilidade 07t / 16t)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#e8fffb; --brand-dark:#0b4c59; --brand-mid:#3db7ac; --white:#fff; --text:#0b1f1e;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --br-lg:16px; --br-md:12px; --br-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      display:flex; align-items:center; justify-content:center;
      padding: clamp(8px, 2vw, 16px);
    }
    .app{ width:min(760px, 100%); margin:auto; }

    /* Cabeçalho */
    .card-header{
      background:var(--brand-dark); color:#fff;
      padding: clamp(18px,5vw,28px) clamp(14px,4vw,20px);
      border-radius: var(--br-lg);
      box-shadow: var(--shadow);
      text-align:center;
    }
    .title{ margin:0; font-weight:900; letter-spacing:.4px; font-size:clamp(22px,5vw,34px) }
    .subtitle{ margin:.25rem 0 0; opacity:.9; font-weight:600; font-size:clamp(13px,3.2vw,16px) }

    /* Cards / títulos menores */
    .card{
      margin-top:12px; background:var(--white);
      border-radius: var(--br-lg); box-shadow: var(--shadow); overflow:hidden;
    }
    .card::before{ content:""; display:block; height:18px; background:var(--brand-mid) }
    h2.section-title{
      margin:12px; background:#3db7ac; color:#0b1f1e;
      font-weight:800; letter-spacing:.4px;
      padding:10px 14px; border-radius: var(--br-md);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size: clamp(15px, 3vw, 18px);
    }
    .section-title small{ font-weight:600; opacity:.9 }
    .muted{ opacity:.85; font-weight:700 }
    .section-body{ padding: 0 12px 12px; }

    .field{ margin-bottom:12px }
    .label{ font-weight:800; letter-spacing:.3px; margin-bottom:6px; display:block }
    .control{
      display:block; width:100%; min-height:44px; font-size:16px;
      padding:10px 12px; border:1px solid #cfd8dc; border-radius:var(--br-sm);
      background:#f9fafa; outline:none;
    }
    .control:focus{ border-color:var(--brand-mid); box-shadow:0 0 0 3px rgba(61,183,172,.25); background:#fff }

    /* Pills (gerenciar frota) */
    .pill-wrap{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:8px; background:#f6fafa; border:1px dashed #cfd8dc; border-radius:12px;
      max-height: 220px; overflow:auto;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; background:#fff; border:1px solid #cfd8dc;
      border-radius:999px; font-weight:700;
    }
    .pill button{
      border:0; background:#ffeaea; color:#a10; border-radius:999px; cursor:pointer;
      width:22px; height:22px; line-height:22px; font-weight:900;
    }
    .inline-add{ display:flex; gap:8px; align-items:center; margin-top:10px }
    .inline-add input{ flex:1 }
    .inline-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }

    .btn{
      border:0; border-radius:12px; padding:12px 14px; font-weight:800; cursor:pointer;
      background:var(--brand-dark); color:#fff; box-shadow:0 6px 14px rgba(1,61,53,.18);
      transition:filter .15s ease;
    }
    .btn:hover{ filter:brightness(1.05) }
    .btn.secondary{ background:#93b8b5; color:#062f2c }
    .btn.ghost{ background:#eef6f5; color:#063a36 }
    .btn[disabled]{ opacity:.7; cursor:not-allowed }

    /* Grids (checkbox pills) */
    .emp-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px 14px;
      align-items:start;
    }
    @media (max-width:520px){ .emp-grid{ grid-template-columns: 1fr } }
    .check-pill{
      display:flex; align-items:center; gap:10px;
      padding:12px 14px; background:#f9fbfb; border:1px solid #cfd8dc;
      border-radius:12px; min-height:46px;
      transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .check-pill input[type="checkbox"]{ width:18px; height:18px; accent-color:#0b4c59; }
    .check-pill span{ letter-spacing:.3px; color:#0b1f1e; font-weight:700 }
    .check-pill:has(input:checked){ background:#fff; border-color:#3db7ac; box-shadow:0 0 0 3px rgba(61,183,172,.22) }

    .actions{ display:flex; gap:10px; justify-content:flex-end; margin:10px 12px 12px; }
    .hidden{ display:none !important; }
    @media (max-width:640px){ .section-title{ flex-wrap:wrap; gap:6px } }

    /* ===== Overlay de carregamento global ===== */
    .busy {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(255,255,255,.65); backdrop-filter: blur(1px) saturate(1.1);
      z-index: 9999;
    }
    .busy.show { display: flex; }
    .busy .box{
      display:flex; align-items:center; gap:12px;
      background:#fff; border-radius:12px; padding:12px 16px;
      box-shadow: var(--shadow); font-weight:800; letter-spacing:.3px;
      color:#063a36;
    }
    .busy .spinner{
      width:18px; height:18px; border-radius:50%;
      border:3px solid #b9e6e1; border-top-color:#3db7ac;
      animation: spin .9s linear infinite;
    }
    @keyframes spin { to{ transform: rotate(360deg) } }
  </style>
</head>
<body>
  <main class="app">
    <!-- Cabeçalho -->
    <header class="card-header">
      <h1 class="title">ATUALIZAÇÃO DISPONIBILIDADE — PDN</h1>
      <p class="subtitle">Empilhadeiras 07 t e 16 t</p>
    </header>

    <!-- DATA / PERÍODO -->
    <section class="card" aria-label="Informações Gerais">
      <h2 class="section-title">DATA E PERÍODO</h2>
      <div class="section-body">
        <div class="info-grid">
          <div class="field">
            <label class="label" for="dtRegistro">Data</label>
            <input class="control" type="date" id="dtRegistro" />
          </div>
          <div class="field">
            <label class="label" for="periodoRegistro">Período</label>
            <select class="control" id="periodoRegistro">
              <option value="">— selecione —</option>
              <option>00-01h</option><option>01-02h</option><option>02-03h</option><option>03-04h</option>
              <option>04-05h</option><option>05-06h</option><option>06-07h</option><option>07-08h</option>
              <option>08-09h</option><option>09-10h</option><option>10-11h</option><option>11-12h</option>
              <option>12-13h</option><option>13-14h</option><option>14-15h</option><option>15-16h</option>
              <option>16-17h</option><option>17-18h</option><option>18-19h</option><option>19-20h</option>
              <option>20-21h</option><option>21-22h</option><option>22-23h</option><option>23-00h</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- 1) GERENCIAR LISTAS (07t e 16t) -->
    <section id="secGerenciar" class="card" aria-label="Gerenciar Frotas">
      <h2 class="section-title">
        <span>LISTAS DE EMPILHADEIRAS (PDN)</span>
        <small class="muted">
          <span id="totalPlacas07">0</span> placas 07t •
          <span id="totalPlacas16">0</span> placas 16t •
          <span id="infoAtualizacao">—</span>
        </small>
      </h2>
      <div class="section-body">
        <!-- 07t -->
        <div class="field">
          <label class="label">Frota 07 toneladas</label>
          <div id="pill07" class="pill-wrap" aria-live="polite"></div>
          <div class="inline-add">
            <input id="novoCodigo07" class="control" placeholder="Adicionar código 07t (ex.: EMP0092)" />
            <button class="btn ghost" id="btnAdd07">Adicionar</button>
          </div>
        </div>
        <!-- 16t -->
        <div class="field">
          <label class="label">Frota 16 toneladas</label>
          <div id="pill16" class="pill-wrap" aria-live="polite"></div>
          <div class="inline-add">
            <input id="novoCodigo16" class="control" placeholder="Adicionar código 16t (ex.: EMP0201)" />
            <button class="btn ghost" id="btnAdd16">Adicionar</button>
          </div>
        </div>

        <div class="inline-actions">
          <button class="btn secondary" id="btnRecarregarLista">Recarregar do servidor</button>
          <button class="btn" id="btnSalvarLista">Salvar listas</button>
        </div>
      </div>
    </section>

    <!-- 2) CLASSIFICAÇÃO (4 seções) -->
    <section id="secClassificacao" class="card hidden" aria-label="Classificação">
      <h2 class="section-title"><span>EMPILHADEIRAS 07 t DISPONÍVEIS</span><small id="countDisp07">0</small></h2>
      <div class="section-body"><div id="gridDisp07" class="emp-grid"></div></div>

      <h2 class="section-title"><span>EMPILHADEIRAS 07 t EM MANUTENÇÃO</span><small id="countMan07">0</small></h2>
      <div class="section-body"><div id="gridMan07" class="emp-grid"></div></div>

      <h2 class="section-title"><span>EMPILHADEIRAS 16 t DISPONÍVEIS</span><small id="countDisp16">0</small></h2>
      <div class="section-body"><div id="gridDisp16" class="emp-grid"></div></div>

      <h2 class="section-title"><span>EMPILHADEIRAS 16 t EM MANUTENÇÃO</span><small id="countMan16">0</small></h2>
      <div class="section-body"><div id="gridMan16" class="emp-grid"></div></div>

      <div class="actions">
        <button class="btn secondary" id="btnLimparSelecao">Limpar seleção</button>
        <button class="btn" id="btnRegistrar">Registrar</button>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modalConfirm" class="modal-overlay">
    <div class="modal">
      <h3 id="modalTitle">Confirmação</h3>
      <p id="modalMsg">Mensagem aqui</p>
      <div class="btns">
        <button class="ok">OK</button>
        <button class="cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Overlay de carregamento -->
  <div id="busy" class="busy" aria-live="polite" aria-busy="false">
    <div class="box"><span class="spinner" aria-hidden="true"></span><span id="busyMsg">Processando…</span></div>
  </div>

  <script>
    /************ CONFIG ************/
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxe-_Yhj17NX0ze5GWo2v_W7llQD88gWIDKofhVNUrS8ShK82Hhs3nXHOwRr6nPGbknOg/exec';
    // AÇÕES para o PDN (ajuste se no seu Apps Script forem outros nomes)
    const ACTIONS = {
      getFrota: 'getFrotaPDN',
      saveFrota: 'salvarFrotaPDN',
      saveDM: 'salvarDMPDN'
    };

    // Estado
    let FROTA07 = [];
    let FROTA16 = [];
    let DISP07  = new Set();
    let MAN07   = new Set();
    let DISP16  = new Set();
    let MAN16   = new Set();
    let listaFoiSalva = false;

    /************ UTIL ************/
    const pad = n => String(n).padStart(2,'0');
    const slug = s => String(s||'').trim().toUpperCase().replace(/\s+/g,'');

    function setBusy(on, msg='Processando…'){
      const el = document.getElementById('busy');
      const m  = document.getElementById('busyMsg');
      m.textContent = msg || 'Processando…';
      el.classList.toggle('show', !!on);
      el.setAttribute('aria-busy', on ? 'true' : 'false');
    }
    function setBtnLoading(btn, on, textWhile='Carregando…'){
      if (!btn) return;
      if (on){ btn.dataset._txt = btn.textContent; btn.textContent = textWhile; btn.disabled = true; }
      else { if (btn.dataset._txt) btn.textContent = btn.dataset._txt; btn.disabled = false; }
    }

    function sortPlacas(arr){
      return [...arr].sort((a,b)=>{
        const ma = a.match(/\d+/), mb = b.match(/\d+/);
        const na = ma ? Number(ma[0]) : Infinity;
        const nb = mb ? Number(mb[0]) : Infinity;
        if (na !== nb) return na - nb;
        return a.localeCompare(b);
      });
    }
    function formatTS(ts){
      if (!ts) return '';
      try{
        const d = (ts instanceof Date) ? ts : new Date(ts);
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch(e){ return String(ts); }
    }
    const setInfoAtualizacao = (str) => document.getElementById('infoAtualizacao').textContent = str || '—';
    const setTotals = () => {
      document.getElementById('totalPlacas07').textContent = FROTA07.length;
      document.getElementById('totalPlacas16').textContent = FROTA16.length;
    };

    function showModal(msg, onOk, opts = {}) {
      const overlay = document.getElementById('modalConfirm');
      document.getElementById('modalMsg').textContent = msg;
      overlay.classList.add('show');
      const okBtn = overlay.querySelector('.ok');
      const cancelBtn = overlay.querySelector('.cancel');
      cancelBtn.style.display = opts.hideCancel ? 'none' : '';
      const close = () => overlay.classList.remove('show');
      okBtn.onclick = () => { close(); if (onOk) onOk(); };
      cancelBtn.onclick = close;
    }

    /************ RENDER: PILLS (07/16) ************/
    function renderPills(containerId, arr, onRemove){
      const wrap = document.getElementById(containerId);
      wrap.innerHTML = '';
      sortPlacas(arr).forEach(code=>{
        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.innerHTML = `<strong>${code}</strong><button type="button" aria-label="Remover ${code}">&times;</button>`;
        pill.querySelector('button').addEventListener('click', ()=> onRemove(code));
        wrap.appendChild(pill);
      });
      setTotals();
    }

    /************ RENDER: GRIDS (4 listas) ************/
    function makeCheck(code, grupo){
      const id = `${grupo}-${code}`;
      const lbl = document.createElement('label');
      lbl.className = 'check-pill';
      lbl.innerHTML = `<input type="checkbox" id="${id}" /><span>${code}</span>`;
      const input = lbl.querySelector('input');

      // estado inicial
      if (grupo === 'disp07') input.checked = DISP07.has(code);
      if (grupo === 'man07')  input.checked = MAN07.has(code);
      if (grupo === 'disp16') input.checked = DISP16.has(code);
      if (grupo === 'man16')  input.checked = MAN16.has(code);

      input.addEventListener('change', ()=>{
        switch(grupo){
          case 'disp07': if (input.checked){ DISP07.add(code); MAN07.delete(code); } else DISP07.delete(code); break;
          case 'man07' : if (input.checked){ MAN07.add(code);  DISP07.delete(code);} else MAN07.delete(code);  break;
          case 'disp16': if (input.checked){ DISP16.add(code); MAN16.delete(code); } else DISP16.delete(code); break;
          case 'man16' : if (input.checked){ MAN16.add(code);  DISP16.delete(code);} else MAN16.delete(code);  break;
        }
        renderGrids();
      });
      return lbl;
    }

    function renderGrids(){
      const gD07 = document.getElementById('gridDisp07');
      const gM07 = document.getElementById('gridMan07');
      const gD16 = document.getElementById('gridDisp16');
      const gM16 = document.getElementById('gridMan16');
      gD07.innerHTML = gM07.innerHTML = gD16.innerHTML = gM16.innerHTML = '';

      // cada placa só aparece em UMA das duas listas do seu grupo
      sortPlacas(FROTA07.filter(c => !MAN07.has(c))).forEach(code => gD07.appendChild(makeCheck(code,'disp07')));
      sortPlacas(FROTA07.filter(c => !DISP07.has(c))).forEach(code => gM07.appendChild(makeCheck(code,'man07')));
      sortPlacas(FROTA16.filter(c => !MAN16.has(c))).forEach(code => gD16.appendChild(makeCheck(code,'disp16')));
      sortPlacas(FROTA16.filter(c => !DISP16.has(c))).forEach(code => gM16.appendChild(makeCheck(code,'man16')));

      updateCounts();
    }

    function updateCounts(){
      document.getElementById('countDisp07').textContent = DISP07.size;
      document.getElementById('countMan07').textContent  = MAN07.size;
      document.getElementById('countDisp16').textContent = DISP16.size;
      document.getElementById('countMan16').textContent  = MAN16.size;
    }

    function validarSelecao(){
      // 07t
      const falt07 = [], dup07 = [];
      FROTA07.forEach(code=>{
        const a = DISP07.has(code), b = MAN07.has(code);
        if (!a && !b) falt07.push(code);
        if (a && b)   dup07.push(code);
      });
      // 16t
      const falt16 = [], dup16 = [];
      FROTA16.forEach(code=>{
        const a = DISP16.has(code), b = MAN16.has(code);
        if (!a && !b) falt16.push(code);
        if (a && b)   dup16.push(code);
      });

      if (falt07.length || dup07.length || falt16.length || dup16.length){
        let msg = '⚠️ Classifique todas as empilhadeiras de cada grupo em exatamente um status.\n\n';
        if (dup07.length)  msg += '07t com status duplicado: ' + dup07.join(', ') + '\n';
        if (falt07.length) msg += '07t sem status: ' + falt07.join(', ') + '\n';
        if (dup16.length)  msg += '16t com status duplicado: ' + dup16.join(', ') + '\n';
        if (falt16.length) msg += '16t sem status: ' + falt16.join(', ') + '\n';
        showModal(msg);
        return false;
      }
      return true;
    }

    /************ API ************/
    async function apiGetFrota(){
      const params = new URLSearchParams({ action: ACTIONS.getFrota });
      const resp = await fetch(`${SCRIPT_URL}?${params.toString()}`, { cache:'no-store' });
      const json = await resp.json();
      if (!json.sucesso) throw new Error(json.mensagem || 'Falha ao obter frota PDN');
      return {
        frota07: json.emp07 || [],
        frota16: json.emp16 || [],
        atualizadoEm: json.timestamp ? formatTS(json.timestamp) : ''
      };
    }

    async function apiSalvarFrota(arr07, arr16){
      const body = 'dados=' + encodeURIComponent(JSON.stringify({
        action: ACTIONS.saveFrota,
        dados: { lista07: arr07, lista16: arr16 }
      }));
      const resp = await fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      const json = await resp.json();
      if (!json.sucesso) throw new Error(json.mensagem || 'Falha ao salvar listas PDN');
      return { sucesso:true, atualizadoEm: formatTS(new Date()) };
    }

    async function apiRegistrarSelecao(payload){
      const body = 'dados=' + encodeURIComponent(JSON.stringify({
        action: ACTIONS.saveDM,
        dados: payload   // será salvo na aba lancamentosDM_PDN
      }));
      const resp = await fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      const json = await resp.json();
      if (!json.sucesso) throw new Error(json.mensagem || 'Falha ao registrar DM PDN');
      return json;
    }

    function resetAfterSave(){
      // ajuste o caminho conforme onde este arquivo ficará
      window.location.assign('../index.html');
    }

    /************ HANDLERS: GERENCIAR ************/
    // adicionar/remover 07
    document.getElementById('btnAdd07').addEventListener('click', ()=>{
      const raw = document.getElementById('novoCodigo07').value;
      const code = slug(raw);
      if (!code){ showModal('Informe um código (ex.: EMP0092).'); return; }
      if (!/^EMP\d{3,5}$/.test(code)) if (!confirm('Código fora do padrão EMP0000. Adicionar mesmo assim?')) return;
      if (FROTA07.includes(code) || FROTA16.includes(code)){ showModal('Este código já existe em alguma lista.'); return; }
      FROTA07.push(code); document.getElementById('novoCodigo07').value = '';
      renderPills('pill07', FROTA07, remove07);
    });
    function remove07(code){
      FROTA07 = FROTA07.filter(c=>c!==code);
      DISP07.delete(code); MAN07.delete(code);
      renderPills('pill07', FROTA07, remove07);
      if (listaFoiSalva) renderGrids();
    }

    // adicionar/remover 16
    document.getElementById('btnAdd16').addEventListener('click', ()=>{
      const raw = document.getElementById('novoCodigo16').value;
      const code = slug(raw);
      if (!code){ showModal('Informe um código (ex.: EMP0201).'); return; }
      if (!/^EMP\d{3,5}$/.test(code)) if (!confirm('Código fora do padrão EMP0000. Adicionar mesmo assim?')) return;
      if (FROTA07.includes(code) || FROTA16.includes(code)){ showModal('Este código já existe em alguma lista.'); return; }
      FROTA16.push(code); document.getElementById('novoCodigo16').value = '';
      renderPills('pill16', FROTA16, remove16);
    });
    function remove16(code){
      FROTA16 = FROTA16.filter(c=>c!==code);
      DISP16.delete(code); MAN16.delete(code);
      renderPills('pill16', FROTA16, remove16);
      if (listaFoiSalva) renderGrids();
    }

    document.getElementById('btnSalvarLista').addEventListener('click', async (ev)=>{
      if (!FROTA07.length && !FROTA16.length){ showModal('As listas estão vazias.'); return; }
      const btn = ev.currentTarget;
      try{
        setBtnLoading(btn,true,'Salvando…'); setBusy(true,'Salvando listas…');
        const r = await apiSalvarFrota(sortPlacas(FROTA07), sortPlacas(FROTA16));
        setInfoAtualizacao(r.atualizadoEm || 'agora');
        showModal('✅ Listas salvas! A classificação foi liberada.');
        listaFoiSalva = true;
        document.getElementById('secClassificacao').classList.remove('hidden');
        document.getElementById('secGerenciar').classList.add('hidden');
        document.getElementById('secClassificacao').scrollIntoView({behavior:'smooth', block:'start'});
        // limpar seleções
        DISP07.clear(); MAN07.clear(); DISP16.clear(); MAN16.clear();
        renderGrids();
      }catch(e){
        console.error(e); showModal('❌ Não foi possível salvar as listas.');
      }finally{ setBusy(false); setBtnLoading(btn,false); }
    });

    document.getElementById('btnRecarregarLista').addEventListener('click', async (ev)=>{
      const btn = ev.currentTarget;
      try{
        setBtnLoading(btn,true,'Recarregando…'); setBusy(true,'Carregando listas…');
        const data = await apiGetFrota();
        FROTA07 = data.frota07 || [];
        FROTA16 = data.frota16 || [];
        setInfoAtualizacao(data.atualizadoEm || '—');
        renderPills('pill07', FROTA07, remove07);
        renderPills('pill16', FROTA16, remove16);
        if (listaFoiSalva){ DISP07.clear(); MAN07.clear(); DISP16.clear(); MAN16.clear(); renderGrids(); }
      }catch(e){
        console.error(e); showModal('❌ Não foi possível recarregar as listas.');
      }finally{ setBusy(false); setBtnLoading(btn,false); }
    });

    /************ HANDLERS: CLASSIFICAÇÃO ************/
    document.getElementById('btnLimparSelecao').addEventListener('click', ()=>{
      DISP07.clear(); MAN07.clear(); DISP16.clear(); MAN16.clear();
      renderGrids();
    });

    document.getElementById('btnRegistrar').addEventListener('click', async (ev)=>{
      if (!validarSelecao()) return;

      const periodoSel = document.getElementById('periodoRegistro').value;
      const dataISO    = document.getElementById('dtRegistro').value;
      if (!dataISO){ showModal('Selecione uma data para registrar.'); return; }
      if (!periodoSel){ showModal('Selecione um período para registrar.'); return; }

      const btn = ev.currentTarget;
      try{
        setBtnLoading(btn,true,'Registrando…'); setBusy(true,'Registrando disponibilidade…');

        const payload = {
          data: dataISO,
          periodo: periodoSel,
          // 07 toneladas → colunas C/D
          emp_07_disponiveis:  Array.from(DISP07).join(','),
          emp_07_manutencao:   Array.from(MAN07).join(','),
          // 16 toneladas → colunas G/H
          emp_16_disponiveis:  Array.from(DISP16).join(','),
          emp_16_manutencao:   Array.from(MAN16).join(',')
        };

        await apiRegistrarSelecao(payload);

        // limpa seleções e campos
        DISP07.clear(); MAN07.clear(); DISP16.clear(); MAN16.clear();
        document.getElementById('periodoRegistro').value = '';
        renderGrids();

        showModal('✅ Registro DM salvo com sucesso!', () => resetAfterSave(), { hideCancel:true });
      }catch(e){
        console.error(e); showModal('❌ Não foi possível salvar o registro DM.');
      }finally{ setBusy(false); setBtnLoading(btn,false); }
    });

    /************ BOOT ************/
    (async function init(){
      try{
        setBusy(true, 'Carregando listas…');
        const data = await apiGetFrota();
        FROTA07 = data.frota07 || [];
        FROTA16 = data.frota16 || [];
        setInfoAtualizacao(data.atualizadoEm || '—');
      }catch(err){
        console.warn('Sem lista no servidor; carregando exemplo…');
        FROTA07 = ['EMP0007','EMP0008','EMP0009'];
        FROTA16 = ['EMP0201','EMP0202'];
        setInfoAtualizacao('lista local (fallback)');
      }finally{
        setBusy(false);
      }
      renderPills('pill07', FROTA07, remove07);
      renderPills('pill16', FROTA16, remove16);
      document.getElementById('secClassificacao').classList.add('hidden');
    })();

    // Data de hoje padrão
    window.addEventListener('DOMContentLoaded', () => {
      const d = new Date();
      const hoje = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const el = document.getElementById('dtRegistro');
      if (el && !el.value) el.value = hoje;
    });
  </script>
</body>
</html>