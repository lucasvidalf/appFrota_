<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DM — Empilhadeiras PDN (Gerenciar + Disponibilidade)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#e8fffb; --brand-dark:#0b4c59; --brand-mid:#3db7ac; --white:#fff; --text:#0b1f1e;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --br-lg:16px; --br-md:12px; --br-sm:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      display:flex; align-items:flex-start; justify-content:center;
      padding: clamp(8px, 2vw, 16px);
    }
    .app{ width:min(900px, 100%); margin:auto; }

    /* Cabeçalho */
    .card-header{
      background:var(--brand-dark); color:#fff;
      padding: clamp(18px,5vw,28px) clamp(14px,4vw,20px);
      border-radius: var(--br-lg);
      box-shadow: var(--shadow);
      text-align:center;
    }
    .title{ margin:0; font-weight:900; letter-spacing:.4px; font-size:clamp(22px,5vw,34px) }
    .subtitle{ margin:.25rem 0 0; opacity:.9; font-weight:600; font-size:clamp(13px,3.2vw,16px) }

    /* Cards */
    .card{
      margin-top:12px; background:var(--white);
      border-radius: var(--br-lg); box-shadow: var(--shadow); overflow:hidden;
    }
    .card::before{ content:""; display:block; height:18px; background:var(--brand-mid) }

    /* Títulos menores */
    h2.section-title{
      margin:12px; background:#3db7ac; color:#0b1f1e;
      font-weight:800; letter-spacing:.4px;
      padding:10px 14px; border-radius: var(--br-md);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size: clamp(15px, 3vw, 18px);
    }
    .section-title small{ font-weight:600; opacity:.9 }
    .muted{ opacity:.85; font-weight:700 }

    .section-body{ padding: 0 12px 12px; }
    .field{ margin-bottom:12px }
    .label{ font-weight:800; letter-spacing:.3px; margin-bottom:6px; display:block }
    .control{
      display:block; width:100%; min-height:44px; font-size:16px;
      padding:10px 12px; border:1px solid #cfd8dc; border-radius:var(--br-sm);
      background:#f9fafa; outline:none;
    }
    .control:focus{ border-color:var(--brand-mid); box-shadow:0 0 0 3px rgba(61,183,172,.25); background:#fff }

    /* grid para a área DATA/PERÍODO */
    .info-grid{
      display:grid; gap:12px; grid-template-columns:1fr 1fr;
    }
    @media (max-width:520px){ .info-grid{ grid-template-columns:1fr } }

    /* Pills (gerenciar frota) */
    .pill-wrap{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:8px; background:#f6fafa; border:1px dashed #cfd8dc; border-radius:12px;
      max-height: 220px; overflow:auto;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; background:#fff; border:1px solid #cfd8dc;
      border-radius:999px; font-weight:700;
    }
    .pill button{
      border:0; background:#ffeaea; color:#a10; border-radius:999px; cursor:pointer;
      width:22px; height:22px; line-height:22px; font-weight:900;
    }
    .inline-add{ display:flex; gap:8px; align-items:center; margin-top:10px; }
    .inline-add input{ flex:1 }
    .inline-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }

    .btn{
      border:0; border-radius:12px; padding:12px 14px; font-weight:800; cursor:pointer;
      background:var(--brand-dark); color:#fff; box-shadow:0 6px 14px rgba(1,61,53,.18);
      transition:filter .15s ease;
    }
    .btn:hover{ filter:brightness(1.05) }
    .btn.secondary{ background:#93b8b5; color:#062f2c }
    .btn.ghost{ background:#eef6f5; color:#063a36 }
    .btn[disabled]{ opacity:.7; cursor:not-allowed }

    /* Grids (checkbox pills) */
    .emp-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px 14px;
      align-items:start;
    }
    @media (max-width:520px){ .emp-grid{ grid-template-columns: 1fr } }

    .check-pill{
      display:flex; align-items:center; gap:10px;
      padding:12px 14px; background:#f9fbfb; border:1px solid #cfd8dc;
      border-radius:12px; min-height:46px;
      transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .check-pill input[type="checkbox"]{ width:18px; height:18px; accent-color:#0b4c59; }
    .check-pill span{ letter-spacing:.3px; color:#0b1f1e; font-weight:700 }
    .check-pill:has(input:checked){ background:#fff; border-color:#3db7ac; box-shadow:0 0 0 3px rgba(61,183,172,.22) }

    .actions{ display:flex; gap:10px; justify-content:flex-end; margin:10px 12px 12px; }
    .hidden{ display:none !important; }
    @media (max-width:640px){ .section-title{ flex-wrap:wrap; gap:6px } }

    /* Modal (corrigido: começa display:none) */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.4);
      display: none; align-items: center; justify-content: center;
      z-index: 10000;
    }
    .modal-overlay.show { display:flex; }
    .modal {
      background: #fff; padding: 24px; border-radius: 14px;
      max-width: 320px; text-align: center;
      box-shadow: 0 8px 24px rgba(0,0,0,.2);
    }
    .modal h3 { margin-top: 0; font-size: 18px; font-weight: 800; }
    .modal p { margin: 12px 0 20px; }
    .modal .btns { display: flex; gap: 10px; justify-content: center; }
    .modal .btns button { border: 0; border-radius: 8px; padding: 10px 16px; font-weight: 700; cursor: pointer; }
    .modal .btns .ok { background: #0b4c59; color:#fff; }
    .modal .btns .cancel { background: #eee; }

    /* Overlay de carregamento */
    .busy {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(255,255,255,.65); backdrop-filter: blur(1px) saturate(1.1);
      z-index: 9999;
    }
    .busy.show { display: flex; }
    .busy .box{ display:flex; align-items:center; gap:12px; background:#fff; border-radius:12px; padding:12px 16px; box-shadow: var(--shadow); font-weight:800; letter-spacing:.3px; color:#063a36; }
    .busy .spinner{ width:18px; height:18px; border-radius:50%; border:3px solid #b9e6e1; border-top-color:#3db7ac; animation: spin .9s linear infinite; }
    @keyframes spin { to{ transform: rotate(360deg) } }
  </style>
</head>
<body>
  <main class="app">
    <header class="card-header">
      <h1 class="title">ATUALIZAÇÃO DISPONIBILIDADE</h1>
      <p class="subtitle">Intermodal Pederneiras</p>
    </header>

    <!-- DATA + PERÍODO -->
    <section class="card" aria-label="Informações Gerais">
      <h2 class="section-title">DATA E PERÍODO</h2>
      <div class="section-body">
        <div class="info-grid">
          <div class="field">
            <label class="label" for="dtRegistro">Data</label>
            <input class="control" type="date" id="dtRegistro" />
          </div>
          <div class="field">
            <label class="label" for="periodoRegistro">Período</label>
            <select class="control" id="periodoRegistro">
              <option value="">— selecione —</option>
              <option>00-01h</option><option>01-02h</option><option>02-03h</option><option>03-04h</option>
              <option>04-05h</option><option>05-06h</option><option>06-07h</option><option>07-08h</option>
              <option>08-09h</option><option>09-10h</option><option>10-11h</option><option>11-12h</option>
              <option>12-13h</option><option>13-14h</option><option>14-15h</option><option>15-16h</option>
              <option>16-17h</option><option>17-18h</option><option>18-19h</option><option>19-20h</option>
              <option>20-21h</option><option>21-22h</option><option>22-23h</option><option>23-00h</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- GERENCIAR FROTAS -->
    <section id="secGerenciar" class="card" aria-label="Gerenciar Frotas PDN">
      <!-- 07t -->
      <h2 class="section-title">
        <span>LISTA DE EMPILHADEIRAS 07 t</span>
        <small class="muted">
          <span id="totalPlacas7">0</span> placas • Atualizado: <span id="infoAtualizacao">—</span>
        </small>
      </h2>
      <div class="section-body">
        <h3 style="margin:8px 2px 6px">Frota 07 toneladas</h3>
        <div id="pillContainer7" class="pill-wrap" aria-live="polite"></div>
        <div class="inline-add">
          <input id="novoCodigo7" class="control" placeholder="Adicionar código 07t (ex.: EMP0701)" />
          <button class="btn ghost" id="btnAdicionar7">Adicionar</button>
        </div>
      </div><!-- FECHA section-body 07t ✅ -->

      <!-- 16t -->
      <h2 class="section-title">
        <span>LISTA DE EMPILHADEIRAS 16 t</span>
        <small class="muted"><span id="totalPlacas16">0</span> placas</small>
      </h2>
      <div class="section-body">
        <h3 style="margin:8px 2px 6px">Frota 16 toneladas</h3>
        <div id="pillContainer16" class="pill-wrap" aria-live="polite"></div>
        <div class="inline-add">
          <input id="novoCodigo16" class="control" placeholder="Adicionar código 16t (ex.: EMP1601)" />
          <button class="btn ghost" id="btnAdicionar16">Adicionar</button>
        </div>

        <div class="inline-actions">
          <button class="btn secondary" id="btnRecarregarLista">Recarregar do servidor</button>
          <button class="btn" id="btnSalvarLista">Salvar listas</button>
        </div>
      </div>
    </section>

    <!-- CLASSIFICAÇÕES (4 grupos) -->
    <section id="secClassificacao" class="card hidden" aria-label="Classificação">
      <h2 class="section-title">
        <span>EMPILHADEIRAS 07 t DISPONÍVEIS</span><small id="countDisp7">0</small>
      </h2>
      <div class="section-body"><div id="gridDisp7" class="emp-grid"></div></div>

      <h2 class="section-title">
        <span>EMPILHADEIRAS 07 t EM MANUTENÇÃO</span><small id="countMan7">0</small>
      </h2>
      <div class="section-body"><div id="gridMan7" class="emp-grid"></div></div>

      <h2 class="section-title">
        <span>EMPILHADEIRAS 16 t DISPONÍVEIS</span><small id="countDisp16">0</small>
      </h2>
      <div class="section-body"><div id="gridDisp16" class="emp-grid"></div></div>

      <h2 class="section-title">
        <span>EMPILHADEIRAS 16 t EM MANUTENÇÃO</span><small id="countMan16">0</small>
      </h2>
      <div class="section-body"><div id="gridMan16" class="emp-grid"></div></div>

      <div class="actions">
        <button class="btn secondary" id="btnLimparSelecao">Limpar seleção</button>
        <button class="btn" id="btnRegistrar">Registrar</button>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div id="modalConfirm" class="modal-overlay" aria-hidden="true">
    <div class="modal">
      <h3 id="modalTitle">Confirmação</h3>
      <p id="modalMsg">Mensagem aqui</p>
      <div class="btns">
        <button class="ok">OK</button>
        <button class="cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Overlay de carregamento -->
  <div id="busy" class="busy" aria-live="polite" aria-busy="false">
    <div class="box"><span class="spinner" aria-hidden="true"></span><span id="busyMsg">Processando…</span></div>
  </div>

  <script>
    /************ CONFIG ************/
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxe-_Yhj17NX0ze5GWo2v_W7llQD88gWIDKofhVNUrS8ShK82Hhs3nXHOwRr6nPGbknOg/exec';

    // Estado
    let FROTA7 = [];  // lista 07t
    let FROTA16 = []; // lista 16t
    let DISP7 = new Set(), MAN7 = new Set();
    let DISP16 = new Set(), MAN16 = new Set();
    let listasSalvas = false;

    /************ UTIL ************/
    const pad = n => String(n).padStart(2,'0');
    const slug = s => String(s||'').trim().toUpperCase().replace(/\s+/g,'');

    function setBusy(on, msg='Processando…'){
      const el = document.getElementById('busy');
      const m  = document.getElementById('busyMsg');
      m.textContent = msg || 'Processando…';
      el.classList.toggle('show', !!on);
      el.setAttribute('aria-busy', on ? 'true' : 'false');
    }
    function setBtnLoading(btn, on, textWhile='Carregando…'){
      if (!btn) return;
      if (on){ btn.dataset._txt = btn.textContent; btn.textContent = textWhile; btn.disabled = true; }
      else   { btn.textContent = btn.dataset._txt || btn.textContent; btn.disabled = false; }
    }

    function sortPlacas(arr){
      return [...arr].sort((a,b)=>{
        const ma = a.match(/\d+/), mb = b.match(/\d+/);
        const na = ma ? Number(ma[0]) : Infinity;
        const nb = mb ? Number(mb[0]) : Infinity;
        if (na !== nb) return na - nb;
        return a.localeCompare(b);
      });
    }
    function formatTS(ts){
      if (!ts) return '';
      try{
        const d = (ts instanceof Date) ? ts : new Date(ts);
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch(e){ return String(ts); }
    }

    const setInfoAtualizacao = (str) => {
      const el = document.getElementById('infoAtualizacao');
      if (el) el.textContent = str || '—';
    };
    const setTotals = () => {
      const t7   = document.getElementById('totalPlacas7');
      const t16  = document.getElementById('totalPlacas16');
      if (t7)  t7.textContent  = FROTA7.length;
      if (t16) t16.textContent = FROTA16.length;
    };

    function showModal(msg, onOk, opts = {}) {
      const overlay = document.getElementById('modalConfirm');
      document.getElementById('modalMsg').textContent = msg;
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');

      const okBtn = overlay.querySelector('.ok');
      const cancelBtn = overlay.querySelector('.cancel');

      const hideCancel = opts.hideCancel === true;
      cancelBtn.style.display = hideCancel ? 'none' : '';

      const close = () => { overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); };

      okBtn.onclick = () => { close(); if (onOk) onOk(); };
      cancelBtn.onclick = close;
    }

    /************ RENDER — PILLS ************/
    function renderPills(list, containerId, setDisp, setMan){
      const wrap = document.getElementById(containerId);
      wrap.innerHTML = '';
      sortPlacas(list).forEach(code=>{
        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.innerHTML = `<strong>${code}</strong><button type="button" aria-label="Remover ${code}">&times;</button>`;
        pill.querySelector('button').addEventListener('click', ()=>{
          const idx = list.indexOf(code);
          if (idx>-1) list.splice(idx,1);
          setDisp.delete(code); setMan.delete(code);
          drawAll();
        });
        wrap.appendChild(pill);
      });
      setTotals();
    }

    /************ RENDER — GRIDS (4) ************/
    function makeCheck(code, grupo){
      const id = `${grupo}-${code}`;
      const lbl = document.createElement('label');
      lbl.className = 'check-pill';
      lbl.innerHTML = `<input type="checkbox" id="${id}" /><span>${code}</span>`;
      const input = lbl.querySelector('input');

      if (grupo === 'disp7')  input.checked = DISP7.has(code);
      if (grupo === 'man7')   input.checked = MAN7.has(code);
      if (grupo === 'disp16') input.checked = DISP16.has(code);
      if (grupo === 'man16')  input.checked = MAN16.has(code);

      input.addEventListener('change', ()=>{
        if (grupo === 'disp7'){   if (input.checked){ DISP7.add(code); MAN7.delete(code);} else DISP7.delete(code); }
        if (grupo === 'man7'){    if (input.checked){ MAN7.add(code);  DISP7.delete(code);} else MAN7.delete(code);  }
        if (grupo === 'disp16'){  if (input.checked){ DISP16.add(code);MAN16.delete(code);} else DISP16.delete(code);}
        if (grupo === 'man16'){   if (input.checked){ MAN16.add(code); DISP16.delete(code);} else MAN16.delete(code); }
        drawGrids();
      });

      return lbl;
    }

    function drawGrids(){
      const gD7  = document.getElementById('gridDisp7');
      const gM7  = document.getElementById('gridMan7');
      const gD16 = document.getElementById('gridDisp16');
      const gM16 = document.getElementById('gridMan16');
      gD7.innerHTML = gM7.innerHTML = gD16.innerHTML = gM16.innerHTML = '';

      sortPlacas(FROTA7.filter(c => !MAN7.has(c))).forEach(c => gD7.appendChild(makeCheck(c,'disp7')));
      sortPlacas(FROTA7.filter(c => !DISP7.has(c))).forEach(c => gM7.appendChild(makeCheck(c,'man7')));

      sortPlacas(FROTA16.filter(c => !MAN16.has(c))).forEach(c => gD16.appendChild(makeCheck(c,'disp16')));
      sortPlacas(FROTA16.filter(c => !DISP16.has(c))).forEach(c => gM16.appendChild(makeCheck(c,'man16')));

      document.getElementById('countDisp7').textContent  = DISP7.size;
      document.getElementById('countMan7').textContent   = MAN7.size;
      document.getElementById('countDisp16').textContent = DISP16.size;
      document.getElementById('countMan16').textContent  = MAN16.size;
    }

    function drawAll(){
      renderPills(FROTA7,  'pillContainer7',  DISP7, MAN7);
      renderPills(FROTA16, 'pillContainer16', DISP16, MAN16);
      if (listasSalvas) drawGrids();
    }

    function validarSelecao(){
      const falt = [], dup = [];
      const chk = (lista, dSet, mSet) => {
        lista.forEach(code=>{
          const a = dSet.has(code), b = mSet.has(code);
          if (!a && !b) falt.push(code);
          if (a && b)   dup.push(code);
        });
      };
      chk(FROTA7, DISP7, MAN7);
      chk(FROTA16, DISP16, MAN16);

      if (falt.length){ showModal(`⚠️ Há placas sem status:\n• ${falt.join(', ')}`); return false; }
      if (dup.length){  showModal(`⚠️ Há placas com status duplicado:\n• ${dup.join(', ')}`); return false; }
      return true;
    }

    /************ API ************/
    async function apiGetFrotaPDN(){
      const params = new URLSearchParams({ action: 'getFrotaPDN' });
      const resp = await fetch(`${SCRIPT_URL}?${params.toString()}`, { cache:'no-store' });
      const json = await resp.json();
      if (!json.sucesso) throw new Error(json.mensagem || 'Falha ao obter frota PDN');
      return {
        frota7:  json.emp7  || [],
        frota16: json.emp16 || [],
        atualizadoEm: json.timestamp ? formatTS(json.timestamp) : ''
      };
    }

    async function apiSalvarFrotaPDN(lista7, lista16){
      const body = 'dados=' + encodeURIComponent(JSON.stringify({
        action: 'salvarFrotaPDN',
        dados: { lista7, lista16 }
      }));
      const resp = await fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      const json = await resp.json();
      if (!json.sucesso) throw new Error(json.mensagem || 'Falha ao salvar listas PDN');
      return { sucesso:true, atualizadoEm: formatTS(new Date()) };
    }

    async function apiRegistrarSelecaoPDN(payload){
      const body = 'dados=' + encodeURIComponent(JSON.stringify({
        action: 'salvarDMPDN',
        dados: payload
      }));
      const resp = await fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      const json = await resp.json();
      if (!json.sucesso) throw new Error(json.mensagem || 'Falha ao registrar DM PDN');
      return json;
    }

    /************ HANDLERS ************/
    document.getElementById('btnAdicionar7').addEventListener('click', ()=>{
      const raw = document.getElementById('novoCodigo7').value;
      const code = slug(raw);
      if (!code){ showModal('Informe um código 07t.'); return; }
      if (FROTA7.includes(code)){ showModal('Código já existe na lista 07t.'); return; }
      FROTA7.push(code);
      document.getElementById('novoCodigo7').value = '';
      drawAll();
    });

    document.getElementById('btnAdicionar16').addEventListener('click', ()=>{
      const raw = document.getElementById('novoCodigo16').value;
      const code = slug(raw);
      if (!code){ showModal('Informe um código 16t.'); return; }
      if (FROTA16.includes(code)){ showModal('Código já existe na lista 16t.'); return; }
      FROTA16.push(code);
      document.getElementById('novoCodigo16').value = '';
      drawAll();
    });

    document.getElementById('btnSalvarLista').addEventListener('click', async (ev)=>{
      if (!FROTA7.length && !FROTA16.length){ showModal('As listas estão vazias.'); return; }
      const btn = ev.currentTarget;
      try{
        setBtnLoading(btn,true,'Salvando…'); setBusy(true,'Salvando listas…');
        const r = await apiSalvarFrotaPDN(sortPlacas(FROTA7), sortPlacas(FROTA16));
        setInfoAtualizacao(r.atualizadoEm || 'agora');
        showModal('✅ Listas salvas! A classificação foi liberada.');

        listasSalvas = true;
        document.getElementById('secClassificacao').classList.remove('hidden');
        document.getElementById('secGerenciar').classList.add('hidden');
        DISP7.clear(); MAN7.clear(); DISP16.clear(); MAN16.clear();
        drawGrids();
      }catch(err){
        console.error(err); showModal('❌ Não foi possível salvar as listas.');
      }finally{
        setBusy(false); setBtnLoading(btn,false);
      }
    });

    document.getElementById('btnRecarregarLista').addEventListener('click', async (ev)=>{
      const btn = ev.currentTarget;
      try{
        setBtnLoading(btn,true,'Recarregando…'); setBusy(true,'Carregando listas…');
        const data = await apiGetFrotaPDN();
        FROTA7 = data.frota7 || [];
        FROTA16= data.frota16 || [];
        setInfoAtualizacao(data.atualizadoEm || '—');
        drawAll();
        if (listasSalvas){ DISP7.clear(); MAN7.clear(); DISP16.clear(); MAN16.clear(); drawGrids(); }
      }catch(err){
        console.error(err); showModal('❌ Não foi possível recarregar as listas.');
      }finally{
        setBusy(false); setBtnLoading(btn,false);
      }
    });

    document.getElementById('btnLimparSelecao').addEventListener('click', ()=>{
      DISP7.clear(); MAN7.clear(); DISP16.clear(); MAN16.clear();
      drawGrids();
    });

    document.getElementById('btnRegistrar').addEventListener('click', async (ev)=>{
      if (!validarSelecao()) return;
      const periodoSel = document.getElementById('periodoRegistro').value;
      const dataISO    = document.getElementById('dtRegistro').value;
      if (!dataISO){ showModal('Selecione uma data.'); return; }
      if (!periodoSel){ showModal('Selecione um período.'); return; }

      const btn = ev.currentTarget;
      try{
        setBtnLoading(btn,true,'Registrando…'); setBusy(true,'Registrando disponibilidade…');

        const payload = {
          data: dataISO,
          periodo: periodoSel,
          emp7_disp:  Array.from(DISP7).join(','),
          emp7_man:   Array.from(MAN7).join(','),
          emp16_disp: Array.from(DISP16).join(','),
          emp16_man:  Array.from(MAN16).join(',')
        };

        await apiRegistrarSelecaoPDN(payload);

        DISP7.clear(); MAN7.clear(); DISP16.clear(); MAN16.clear();
        drawGrids();

        showModal('✅ Registro DM (PDN) salvo com sucesso!', null, { hideCancel:true });
      }catch(err){
        console.error(err);
        showModal('❌ Não foi possível salvar o registro DM (PDN).');
      }finally{
        setBusy(false); setBtnLoading(btn,false);
      }
    });

    /************ BOOT ************/
    (async function init(){
      try{
        setBusy(true,'Carregando listas…');
        const data = await apiGetFrotaPDN();
        FROTA7  = data.frota7  || [];
        FROTA16 = data.frota16 || [];
        setInfoAtualizacao(data.atualizadoEm || '—');
      }catch(err){
        console.warn('Sem listas no servidor; usando fallback de exemplo.');
        FROTA7  = ['EMP0007','EMP0008','EMP0009'];  // fallback visual
        FROTA16 = ['EMP0201','EMP0202'];           // fallback visual
        setInfoAtualizacao('lista local (fallback)');
      }finally{
        setBusy(false);
      }
      drawAll();
      document.getElementById('secClassificacao').classList.add('hidden');

      const d = new Date();
      const hoje = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const el = document.getElementById('dtRegistro');
      if (el && !el.value) el.value = hoje;
    })();
  </script>
</body>
</html>
