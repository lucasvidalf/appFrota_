<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>PDN — Gráfico Resumo (Período + Dia)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#e8fffb; --brand-dark:#0b4c59; --brand-mid:#3db7ac; --white:#fff; --text:#0b1f1e;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --br-lg:16px; --br-md:12px; --br-sm:10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    display:flex; align-items:flex-start; justify-content:center;
    padding: clamp(8px, 2vw, 16px);
  }
  .app{ width:min(980px, 100%); margin:auto; }

  .card-header{
    background:var(--brand-dark); color:#fff;
    padding: clamp(18px,5vw,28px) clamp(14px,4vw,20px);
    border-radius: var(--br-lg);
    box-shadow: var(--shadow);
    text-align:center;
  }
  .title{ margin:0; font-weight:900; letter-spacing:.4px; font-size:clamp(22px,5vw,34px) }
  .subtitle{ margin:.25rem 0 0; opacity:.9; font-weight:600; font-size:clamp(13px,3.2vw,16px) }

  .card{ margin-top:12px; background:var(--white); border-radius: var(--br-lg); box-shadow: var(--shadow); overflow:hidden; }
  .card::before{ content:""; display:block; height:18px; background:var(--brand-mid) }
  .section-title{
    margin:12px; background:#3db7ac; color:#0b1f1e;
    font-weight:800; letter-spacing:.4px;
    padding:10px 14px; border-radius: var(--br-md);
    display:flex; align-items:center; gap:10px;
    font-size: clamp(12px, 2.1vw, 14px);
  }

  .filters{ display:grid; gap:10px 12px; grid-template-columns: 1fr 1fr 1fr 1fr; padding:0 12px 6px; }
  .filters .field{ display:flex; flex-direction:column; gap:6px; }
  .label{ font-weight:800; letter-spacing:.3px }
  .control{
    display:block; width:100%; min-height:44px; font-size:16px;
    padding:10px 12px; border:1px solid #cfd8dc; border-radius:var(--br-sm);
    background:#f9fafa; outline:none;
  }
  .control:focus{ border-color:var(--brand-mid); box-shadow:0 0 0 3px rgba(61,183,172,.25); background:#fff }
  input[type="date"].control{ appearance:none;-webkit-appearance:none;-moz-appearance:none }

  @media (max-width:640px){ .filters{ grid-template-columns: 1fr 1fr; } }
  @media (max-width:480px){ .filters{ grid-template-columns: 1fr; } }

  .chart-card{ padding: 0 12px 12px; }
  .chart-head{ display:flex; align-items:center; gap:10px; margin:0 12px 8px; }
  .chart-head .grow{ flex:1 }

  .nav-janela{ display:flex; align-items:center; gap:8px; font-weight:800 }
  .nav-janela button{ border:1px solid #cfd8dc; background:#eef6f5; color:#063a36; border-radius:10px; padding:6px 10px; cursor:pointer; }
  .small{ font-size:12px; opacity:.85; font-weight:800 }

  .chart-wrap{
    position: relative; width: 100%;
    height: clamp(360px, 42vh, 560px);
    border-radius: var(--br-md);
    overflow-x: auto;
    background:#fff;
  }
  .chart-wrap canvas{ min-width: 640px; display:block; }
  @media (max-width:640px){
    .chart-wrap canvas{ min-width: 100% !important; }
  }

  .loading {
    position:absolute; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(255,255,255,.65); backdrop-filter:saturate(1.1) blur(1px);
    z-index:2; font-weight:800; letter-spacing:.3px; border-radius: var(--br-md);
  }
  .loading.show{ display:flex; }
  .loading::before{
    content:""; width:18px; height:18px; margin-right:10px; border-radius:50%;
    border:3px solid #b9e6e1; border-top-color:var(--brand-mid); animation:spin 0.9s linear infinite;
  }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  .totals{ display:inline-flex; gap:8px; margin-left:auto; vertical-align:middle; flex-wrap:wrap; }
  .badge{
    display:inline-flex; gap:6px; align-items:center; padding:4px 8px; border-radius:999px;
    background:#e9fbf8; color:#0b4c59; font-weight:800; font-size:12px;
    box-shadow:0 0 0 1px rgba(61,183,172,.25) inset;
  }
  .badge .dot{ width:10px; height:10px; border-radius:50% }
  .badge.media .dot{ background:#3db7ac }
  .badge.pen  .dot{ background:#183153 }

  .actions{ display:flex; gap:10px; justify-content:flex-end; margin:10px 12px 12px; }
  .btn{ border:0; border-radius:12px; padding:12px 14px; font-weight:800; cursor:pointer;
       background:var(--brand-dark); color:#fff; box-shadow:0 6px 14px rgba(1,61,53,.18); transition:filter .15s ease; }
  .btn:hover{ filter:brightness(1.05) }
  .btn.secondary{ display:none; background:#93b8b5; color:#062f2c }
  .link-btn{ text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    border-radius:12px; padding:12px 14px; font-weight:800; background:var(--brand-dark); color:#fff;
    box-shadow:0 6px 14px rgba(1,61,53,.18);
  }
</style>
</head>
<body>
  <main class="app">
    <header class="card-header">
      <h1 class="title">DISPONIBILIDADE — PDN</h1>
      <p class="subtitle">Resumo dia + Acumulado Mês</p>
    </header>

    <!-- FILTROS -->
    <section class="card" aria-label="Filtros">
      <h2 class="section-title">FILTROS</h2>
      <div class="filters">
        <div class="field">
          <label class="label" for="dtIni">Data inicial</label>
          <input class="control" type="date" id="dtIni" />
        </div>
        <div class="field">
          <label class="label" for="dtFim">Data final</label>
          <input class="control" type="date" id="dtFim" />
        </div>
        <div class="field">
          <label class="label" for="perIni">Período inicial</label>
          <select class="control" id="perIni"></select>
        </div>
        <div class="field">
          <label class="label" for="perFim">Período final</label>
          <select class="control" id="perFim"></select>
        </div>
      </div>
      <div class="actions" style="padding:0 12px 12px">
        <button class="btn secondary" id="btnRecarregar">Recarregar</button>
        <a href="index.html" class="link-btn">Voltar ao menu</a>
      </div>
    </section>

    <!-- GRÁFICO POR PERÍODO -->
    <section class="card chart-card" aria-label="Gráfico Por Período">
      <h2 class="section-title">
        GRÁFICO POR PERÍODO
        <span class="totals">
          <span class="badge media"><span class="dot"></span><span id="tMediaPeriodo07">Média 07t: —</span></span>
          <span class="badge media"><span class="dot"></span><span id="tMediaPeriodo16">Média 16t: —</span></span>
          <span class="badge pen"><span class="dot"></span><span id="tPenPeriodo">Penalidade: —</span></span>
        </span>
      </h2>

      <div class="chart-head">
        <div class="nav-janela">
          <button id="btnPrevJan">◀︎</button>
          <select id="selJanela" class="control" style="max-width:200px;padding:6px 10px;min-height:36px"></select>
          <button id="btnNextJan">▶︎</button>
        </div>
        <div class="grow"></div>
      </div>

      <div class="chart-wrap">
        <div class="loading" id="loadingPeriodo">Carregando…</div>
        <canvas id="graficoPeriodo"></canvas>
      </div>
    </section>

    <!-- GRÁFICO POR DIA -->
    <section class="card chart-card" aria-label="Gráfico Por Dia">
      <h2 class="section-title">
        GRÁFICO POR DIA
        <span class="totals">
          <span class="badge media"><span class="dot"></span><span id="tMediaDia07">Média 07t: —</span></span>
          <span class="badge media"><span class="dot"></span><span id="tMediaDia16">Média 16t: —</span></span>
          <span class="badge pen"><span class="dot"></span><span id="tPenDia">Penalidade: —</span></span>
        </span>
      </h2>

      <div class="chart-head">
        <div class="nav-janela">
          <button id="btnPrevDiaOpt">◀︎</button>
          <select id="visaoDia" class="control" style="max-width:220px">
            <option value="1">Dia</option>
            <option value="5">Últimos 5 dias</option>
            <option value="15">Últimos 15 dias</option>
            <option value="30">Últimos 30 dias</option>
            <option value="all">Visão geral (todos)</option>
          </select>
          <button id="btnNextDiaOpt">▶︎</button>
        </div>
        <div class="grow"></div>
        <!-- setas para navegar só no "todos" -->
        <div class="nav-janela" id="navJanelaDias" style="display:none">
          <button id="btnPrevDiaWin">◀︎</button>
          <span class="small" id="txtJanelaDias"></span>
          <button id="btnNextDiaWin">▶︎</button>
        </div>
      </div>

      <div class="chart-wrap">
        <div class="loading" id="loadingDia">Carregando…</div>
        <canvas id="graficoDia"></canvas>
      </div>
    </section>

  </main>

  <!-- Chart.js + DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <script>
    // ========================
    // CONFIG / CONSTANTES
    // ========================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxe-_Yhj17NX0ze5GWo2v_W7llQD88gWIDKofhVNUrS8ShK82Hhs3nXHOwRr6nPGbknOg/exec';
    const META_PDN = 3;
    const WINDOW_DIAS = 10; // nº de labels visíveis no pager

    const PERIODOS = [
      "00-01h","01-02h","02-03h","03-04h","04-05h","05-06h",
      "06-07h","07-08h","08-09h","09-10h","10-11h","11-12h",
      "12-13h","13-14h","14-15h","15-16h","16-17h","17-18h",
      "18-19h","19-20h","20-21h","21-22h","22-23h","23-00h"
    ];

    const JANELAS = [
      {id:'j0', ini:0,  fim:6,  label:'00–06h'},
      {id:'j1', ini:6,  fim:12, label:'06–12h'},
      {id:'j2', ini:12, fim:18, label:'12–18h'},
      {id:'j3', ini:18, fim:24, label:'18–00h'},
      {id:'all', all:true, label:'Todos os períodos (24)'}
    ];
    let idxJanela = 0;      // janela atual do gráfico por período
    let _diaPageStart = 0;  // início da janela visível (pager) no gráfico por dia

    // ====== Refs DOM ======
    const dtIni = document.getElementById('dtIni');
    const dtFim = document.getElementById('dtFim');
    const perIni = document.getElementById('perIni');
    const perFim = document.getElementById('perFim');

    const btnRecarregar   = document.getElementById('btnRecarregar');
    const loadingPeriodo  = document.getElementById('loadingPeriodo');
    const loadingDia      = document.getElementById('loadingDia');

    const graficoPeriodo  = document.getElementById('graficoPeriodo');
    const graficoDia      = document.getElementById('graficoDia');

    const selJanela       = document.getElementById('selJanela');
    const btnPrevJan      = document.getElementById('btnPrevJan');
    const btnNextJan      = document.getElementById('btnNextJan');

    const visaoDia        = document.getElementById('visaoDia');
    const btnPrevDiaOpt   = document.getElementById('btnPrevDiaOpt');
    const btnNextDiaOpt   = document.getElementById('btnNextDiaOpt');
    const btnPrevDiaWin   = document.getElementById('btnPrevDiaWin');
    const btnNextDiaWin   = document.getElementById('btnNextDiaWin');
    const navJanelaDias   = document.getElementById('navJanelaDias');
    const txtJanelaDias   = document.getElementById('txtJanelaDias');

    // cache
    let _cachePeriodo = null; // {labels, s07, s16, penalties, meta}
    let _cacheDia = null;     // {days, d07, d16, pen}

    Chart.register(ChartDataLabels);

    // ========================
    // HELPERS
    // ========================
    function soma(arr){ return (arr||[]).map(Number).filter(v=>!isNaN(v)).reduce((a,b)=>a+b,0); }
    function mediaSemZeros(arr){ const v=(arr||[]).map(Number).filter(x=>!isNaN(x)&&x>0); return v.length? v.reduce((a,b)=>a+b,0)/v.length : 0; }
    function toLabelBR(iso){ const m=String(iso||'').match(/^(\d{4})-(\d{2})-(\d{2})/); return m? `${m[3]}/${m[2]}` : iso; }

    function stripMediaFinalDias(dias, a1, a2, a3){
      if(!dias.length) return {dias, a1, a2, a3};
      const last = String(dias.at(-1)||'').toLowerCase();
      if(last.startsWith('média')){ return {dias:dias.slice(0,-1), a1:a1.slice(0,-1), a2:a2.slice(0,-1), a3:a3.slice(0,-1)}; }
      return {dias, a1, a2, a3};
    }

    function preencherDiasComZeros(d, dtIniStr, dtFimStr){
      const outDias=[], d07=[], d16=[], pen=[];
      const dtI=new Date(dtIniStr), dtF=new Date(dtFimStr);
      for(let dA=new Date(dtI); dA<=dtF; dA.setDate(dA.getDate()+1)){
        const iso=dA.toISOString().slice(0,10);
        const idx=(d.days||[]).indexOf(iso);
        if(idx>=0){ outDias.push(iso); d07.push(+d.d07[idx]||0); d16.push(+d.d16[idx]||0); pen.push(+d.pen[idx]||0); }
        else{ outDias.push(iso); d07.push(0); d16.push(0); pen.push(0); }
      }
      return {dias:outDias, d07, d16, pen};
    }

    function ajustarLarguraCanvas(canvasId, labels, minWDesktop=760){
      const canvas = document.getElementById(canvasId);
      const wrap   = canvas.parentElement;
      const isMobile = window.innerWidth <= 640;
      if(isMobile){
        canvas.style.width="100%"; canvas.style.height="auto";
        canvas.removeAttribute("width"); canvas.removeAttribute("height");
      }else{
        const pxPorRotulo=38;
        const w=Math.max(minWDesktop, (labels?.length||0)*pxPorRotulo);
        const h=Math.max(460, wrap?wrap.clientHeight:0);
        canvas.width=w; canvas.height=h; canvas.style.width=w+"px"; canvas.style.height=h+"px";
      }
    }

    function setText(id, txt){ const el = document.getElementById(id); if (el) el.textContent = txt; }
    function setLoading(on){
      if(on){ btnRecarregar.disabled = true; btnRecarregar.textContent = 'Carregando…'; loadingPeriodo.classList.add('show'); loadingDia.classList.add('show'); }
      else  { btnRecarregar.disabled = false; btnRecarregar.textContent = 'Recarregar';  loadingPeriodo.classList.remove('show'); loadingDia.classList.remove('show'); }
    }
    function initPeriodos(){
      perIni.innerHTML=''; perFim.innerHTML='';
      perIni.add(new Option('— (todos) —',''));
      perFim.add(new Option('— (todos) —',''));
      PERIODOS.forEach(p=>{ perIni.add(new Option(p,p)); perFim.add(new Option(p,p)); });
      perIni.value=''; perFim.value='';
    }
    function setDatasPadrao(){
      const pad = n => String(n).padStart(2,'0');
      const hoje = new Date();
      const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      if(!dtIni.value) dtIni.value = toISO(hoje);
      if(!dtFim.value) dtFim.value = toISO(hoje);
    }
    function initSelecaoJanela(){
      selJanela.innerHTML='';
      JANELAS.forEach(j => selJanela.add(new Option(j.label, j.id)));
      selJanela.value = JANELAS[idxJanela].id;
    }

    // Totais
    function setTotaisPeriodoPDN(m07,m16,pen){
      setText('tMediaPeriodo07',`Média 07t: ${Math.round(+m07||0)}`);
      setText('tMediaPeriodo16',`Média 16t: ${Math.round(+m16||0)}`);
      setText('tPenPeriodo',`Penalidade: R$ ${Math.round(+pen||0)}`);
    }
    function setTotaisDiaPDN(m07,m16,pen){
      setText('tMediaDia07',`Média 07t: ${Math.round(+m07||0)}`);
      setText('tMediaDia16',`Média 16t: ${Math.round(+m16||0)}`);
      setText('tPenDia',`Penalidade: R$ ${Math.round(+pen||0)}`);
    }

    // evita disparar várias requisições ao mesmo tempo enquanto o usuário está escolhendo a data
     function debounce(fn, wait=300){
       let t; 
       return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
     }

     // garante dtIni <= dtFim (se inverter no calendário do iOS/Android)
     function normalizarIntervalo(){
       const i = new Date(dtIni.value);
       const f = new Date(dtFim.value);
       if (dtIni.value && dtFim.value && i > f){
         // opção 1: troca as datas
         const tmp = dtIni.value;
         dtIni.value = dtFim.value;
         dtFim.value = tmp;
         // opção 2 (se preferir): só iguala
         // dtFim.value = dtIni.value;
       }
     }

   // um único handler para mudanças de filtro
     const onFiltroChange = debounce(()=>{
       normalizarIntervalo();
       carregar();           // já chama o seu fetch + render
     }, 350);


    // ========================
    // FETCH
    // ========================
    async function fetchPeriodoPDN(){
      const params = new URLSearchParams({
        action:'mediaDMResumoPDN_BarrasDuplas',
        dtIni: dtIni.value, dtFim: dtFim.value,
        periodoIni: perIni.value || '', periodoFim: perFim.value || ''
      });
      const resp = await fetch(`${SCRIPT_URL}?${params.toString()}`, { cache:'no-store' });
      const json = await resp.json();
      if(!json.sucesso) throw new Error(json.mensagem || 'Falha ao obter dados (período PDN)');
      return json; // {labels, s07, s16, penalties, meta}
    }
    async function fetchDiaPDN(){
      try{
        const params = new URLSearchParams({ action:'resumoDiarioPDN_BarrasDuplas', dtIni:dtIni.value, dtFim:dtFim.value });
        const resp = await fetch(`${SCRIPT_URL}?${params.toString()}`, { cache:'no-store' });
        const json = await resp.json();
        if(!json.sucesso) throw new Error(json.mensagem || 'Falha (dia PDN)');
        return json; // {days, d07, d16, pen}
      }catch(err){
        console.warn('Resumo diário PDN indisponível:', err.message || err);
        return null;
      }
    }

    // ========================
    // DESENHAR — PERÍODO
    // ========================
    function desenharGraficoPeriodoPDN(labels, s07, s16, penalties, metaArr, highlightIdxs=[]){
      const isMobile = window.matchMedia('(max-width: 480px)').matches;
      ajustarLarguraCanvas('graficoPeriodo', labels);

      const ctx = document.getElementById('graficoPeriodo').getContext('2d');
      if (window._chartPeriodoPDN) window._chartPeriodoPDN.destroy();

      const cor07='#3db7ac', cor16='#0b4c59';
      const bg07 = labels.map((_,i)=> highlightIdxs.includes(i) ? '#2a8f86' : cor07);
      const bg16 = labels.map((_,i)=> highlightIdxs.includes(i) ? '#073b43' : cor16);

      const vmax = Math.max(Math.ceil(Math.max(...s07, ...s16, META_PDN) + 1), META_PDN + 2);

      window._chartPeriodoPDN = new Chart(ctx, {
        data:{ labels,
          datasets:[
            { type:'bar', label:'Média 07t', yAxisID:'y', data:s07,
              backgroundColor:bg07, borderColor:bg07, borderWidth:1, maxBarThickness:isMobile?22:28,
              datalabels:{ display:true, color:(c)=>highlightIdxs.includes(c.dataIndex)?'#fff':'#083735',
                anchor:'center', align:'center', formatter:v=>Math.round(v), font:{weight:800,size:isMobile?9:12} } },
            { type:'bar', label:'Média 16t', yAxisID:'y', data:s16,
              backgroundColor:bg16, borderColor:bg16, borderWidth:1, maxBarThickness:isMobile?22:28,
              datalabels:{ display:true, color:'#fff', anchor:'center', align:'center', formatter:v=>Math.round(v), font:{weight:800,size:isMobile?9:12} } },
            { type:'line', label:`Meta ${META_PDN}`, yAxisID:'y', data:metaArr?.length?metaArr:new Array(labels.length).fill(META_PDN),
              borderColor:'red', borderWidth:2, borderDash:[4,3], pointRadius:0, fill:false, datalabels:{display:false} },
            { type:'line', label:'Penalidades (Σ)', yAxisID:'y1', data:penalties,
              borderColor:'#183153', backgroundColor:'#183153', borderWidth:2, tension:0.25, pointRadius:2,
              datalabels:{ display:true, color:'#183153', anchor:'end', align:'top', rotation:-90, offset:2,
                formatter:v=>`R$ ${Math.round(v)}`, font:{weight:800,size:isMobile?8:11} } }
          ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{display:true,position:'top',
              labels:{usePointStyle:true,pointStyle:'rectRounded',boxWidth:10,boxHeight:10,font:{size:isMobile?11:14}}},
            tooltip:{callbacks:{label:(c)=> c.dataset.yAxisID==='y1' ? ` Penalidades: ${c.parsed.y}` :
                                       (c.dataset.type==='line'? c.dataset.label : ` ${c.dataset.label}: ${c.parsed.y}`)}}
          },
          scales:{
            x:{ticks:{autoSkip:false,maxRotation:90,minRotation:90,font:{weight:800,size:isMobile?8:10}},grid:{display:false}},
            y:{beginAtZero:true,min:0,max:Math.max(10,vmax),display:false,ticks:{precision:0}},
            y1:{position:'right',display:false,min:-5500000,max:2500000,grid:{drawOnChartArea:false},ticks:{precision:0}}
          },
          layout:{padding:{top:6,right:10,bottom:isMobile?64:52,left:6}}
        }
      });
    }

    function renderPeriodo(){
      const p=_cachePeriodo; if(!p) return;

      const labels=(p.labels||[]).slice();
      const s07=(p.s07||[]).map(v=>+v||0);
      const s16=(p.s16||[]).map(v=>+v||0);
      const pens=(p.penalties||[]).map(v=>+v||0);
      const meta=p.meta||[];

      const j = JANELAS[idxJanela];
      if(j.all){
        const idxMedia = labels.findIndex(l=> String(l).toLowerCase().includes('média'));
        const highlights = idxMedia>=0? [idxMedia] : [];
        desenharGraficoPeriodoPDN(labels, s07, s16, pens, meta, highlights);
        setTotaisPeriodoPDN(mediaSemZeros(s07), mediaSemZeros(s16), soma(pens));
      }else{
        const L = labels.slice(j.ini, j.fim);
        const v07 = s07.slice(j.ini, j.fim);
        const v16 = s16.slice(j.ini, j.fim);
        const vp  = pens.slice(j.ini, j.fim);

        const m07 = +mediaSemZeros(v07).toFixed(2);
        const m16 = +mediaSemZeros(v16).toFixed(2);
        const p6  = soma(vp);

        L.push('Média'); v07.push(m07); v16.push(m16); vp.push(p6);
        desenharGraficoPeriodoPDN(L, v07, v16, vp, new Array(L.length).fill(META_PDN), [L.length-1]);
        setTotaisPeriodoPDN(m07, m16, p6);
      }
      selJanela.value = j.id;
    }

    // ========================
    // DESENHAR — DIA
    // ========================
    function desenharGraficoDiaPDN(labelsDias, d07, d16, penalDia, rotateX=false, rotateLine=false, highlights=[]){
      const isMobile = window.matchMedia('(max-width: 480px)').matches;
      ajustarLarguraCanvas('graficoDia', labelsDias, 800);

      const ctx = document.getElementById('graficoDia').getContext('2d');
      if (window._chartDiaPDN) window._chartDiaPDN.destroy();

      const cor07='#3db7ac', cor16='#0b4c59';
      const vmax = Math.max(Math.ceil(Math.max(...d07, ...d16, META_PDN) + 1), META_PDN + 2);

      window._chartDiaPDN = new Chart(ctx,{
        data:{ labels:labelsDias,
          datasets:[
            { type:'bar', label:'Média 07t', yAxisID:'y', data:d07, backgroundColor:cor07, borderColor:cor07, borderWidth:1, maxBarThickness:isMobile?22:28,
              datalabels:{ display:true, color:(c)=> highlights.includes(c.dataIndex)?'#fff':'#083735',
                anchor:'center', align:'center', formatter:v=>Math.round(v), font:{weight:800,size:isMobile?8:11} } },
            { type:'bar', label:'Média 16t', yAxisID:'y', data:d16, backgroundColor:cor16, borderColor:cor16, borderWidth:1, maxBarThickness:isMobile?22:28,
              datalabels:{ display:true, color:'#fff', anchor:'center', align:'center', formatter:v=>Math.round(v), font:{weight:800,size:isMobile?9:12} } },
            { type:'line', label:`Meta ${META_PDN}`, yAxisID:'y', data:new Array(labelsDias.length).fill(META_PDN),
              borderColor:'red', borderWidth:2, borderDash:[4,3], pointRadius:0, fill:false, datalabels:{display:false} },
            { type:'line', label:'Penalidades (Σ)', yAxisID:'y1', data:penalDia,
              borderColor:'#183153', backgroundColor:'#183153', borderWidth:2, tension:0.25, pointRadius:2,
              datalabels:{ display:true, color:'#183153', anchor:'end', align:'top',
                rotation: rotateLine? -90 : 0, offset:2, formatter:v=>`R$ ${Math.round(v)}`,
                font:{weight:800,size:isMobile?8:11} } }
          ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:true,position:'top',
                    labels:{usePointStyle:true,pointStyle:'rectRounded',boxWidth:10,boxHeight:10,font:{size:isMobile?11:14}}},
                    tooltip:{callbacks:{label:(c)=> c.dataset.yAxisID==='y1' ? ` Penalidades: ${c.parsed.y}` :
                                               (c.dataset.type==='line'? c.dataset.label : ` ${c.dataset.label}: ${c.parsed.y}`)}} },
          scales:{
            x:{ticks:{autoSkip:false,maxRotation:rotateX?90:0,minRotation:rotateX?90:0,font:{weight:800,size:isMobile?8:10}},grid:{display:false}},
            y:{beginAtZero:true,min:0,max:Math.max(10,vmax),display:false,ticks:{precision:0}},
            y1:{position:'right',display:false,min:-5000000,max:2500000,grid:{drawOnChartArea:false},ticks:{precision:0}}
          },
          layout:{padding:{top:6,right:10,bottom:isMobile?64:44,left:6}}
        }
      });
    }

    function renderDia(){
      const d=_cacheDia; if(!d) return;

      // completa lacunas no intervalo selecionado
      let {dias, d07, d16, pen} = preencherDiasComZeros(d, dtIni.value, dtFim.value);
      ({dias, a1:d07, a2:d16, a3:pen} = stripMediaFinalDias(dias, d07, d16, pen));

      const rot = dias.map(toLabelBR);
      const modo = visaoDia.value;

      const mediaAcum07 = +mediaSemZeros(d07).toFixed(2);
      const mediaAcum16 = +mediaSemZeros(d16).toFixed(2);
      const penalPeriodo = soma(pen);

      // Dia (último)
      if(modo==='1'){
        const i = rot.length-1;
        desenharGraficoDiaPDN([rot[i]],[d07[i]],[d16[i]],[pen[i]], false, false);
        setTotaisDiaPDN(d07[i], d16[i], penalPeriodo);
        navJanelaDias.style.display='none';
        return;
      }

      // Últimos 30 — sem setas; rótulos X e linha a 90º
      if(modo==='30'){
        const N = Math.min(30, rot.length);
        const start = Math.max(0, rot.length-N);
        let r = rot.slice(start), v07=d07.slice(start), v16=d16.slice(start), p=pen.slice(start);

        const m07 = +mediaSemZeros(v07).toFixed(2);
        const m16 = +mediaSemZeros(v16).toFixed(2);

        const highlights=[];
        if(r.length>=2){
          r.push(`Média ${r.length} dias`); v07.push(m07); v16.push(m16); p.push(soma(p)); highlights.push(r.length-1);
          r.push('Média acumulada'); v07.push(mediaAcum07); v16.push(mediaAcum16); p.push(penalPeriodo); highlights.push(r.length-1);
        }

        desenharGraficoDiaPDN(r, v07, v16, p, true, true, highlights);
        setTotaisDiaPDN(m07, m16, penalPeriodo);
        navJanelaDias.style.display='none';
        return;
      }

      // ALL — pager + rótulos X e linha a 90º
      if(modo==='all'){
        const N = rot.length, startLim=0, maxStart=Math.max(0, N-WINDOW_DIAS);
        if(_diaPageStart<startLim) _diaPageStart=startLim;
        if(_diaPageStart>maxStart) _diaPageStart=maxStart;

        const showPager = N>WINDOW_DIAS;
        navJanelaDias.style.display = showPager? '' : 'none';
        const start = showPager? _diaPageStart : Math.max(0, N-WINDOW_DIAS);
        const end   = showPager? Math.min(start+WINDOW_DIAS, N) : N;

        if(showPager){ txtJanelaDias.textContent=`Exibindo ${start+1}–${end} de ${N}`; }

        let r=rot.slice(start,end), v07=d07.slice(start,end), v16=d16.slice(start,end), p=pen.slice(start,end);
        const m07=+mediaSemZeros(v07).toFixed(2), m16=+mediaSemZeros(v16).toFixed(2);

        const highlights=[];
        if(r.length>=2){
          r.push(`Média ${r.length} dias`); v07.push(m07); v16.push(m16); p.push(soma(p)); highlights.push(r.length-1);
          r.push('Média acumulada'); v07.push(mediaAcum07); v16.push(mediaAcum16); p.push(penalPeriodo); highlights.push(r.length-1);
        }

        desenharGraficoDiaPDN(r, v07, v16, p, true, true, highlights);
        setTotaisDiaPDN(m07, m16, penalPeriodo);
        return;
      }

      // Últimos 5 / 15 — sem rotação 90º
      const N = Number(modo);
      const start = Math.max(0, rot.length-N);
      let r=rot.slice(start), v07=d07.slice(start), v16=d16.slice(start), p=pen.slice(start);

      if(r.length<=1){
        desenharGraficoDiaPDN(r, v07, v16, p, false, false);
        setTotaisDiaPDN(mediaSemZeros(v07), mediaSemZeros(v16), soma(p));
        navJanelaDias.style.display='none';
        return;
      }

      const m07=+mediaSemZeros(v07).toFixed(2), m16=+mediaSemZeros(v16).toFixed(2);
      r.push(`Média ${r.length} dias`); v07.push(m07); v16.push(m16); p.push(soma(p));
      desenharGraficoDiaPDN(r, v07, v16, p, false, false, [r.length-1]);
      setTotaisDiaPDN(m07, m16, soma(p));
      navJanelaDias.style.display='none';
    }

    // ========================
    // CARREGAR
    // ========================
    async function carregar(){
      setLoading(true);
      try{
        const results = await Promise.allSettled([ fetchPeriodoPDN(), fetchDiaPDN() ]);

        // PERÍODO
        if(results[0].status==='fulfilled'){
          const p = results[0].value;
          _cachePeriodo = {
            labels:(p.labels||[]).slice(),
            s07:(p.s07||[]).map(v=>+v||0),
            s16:(p.s16||[]).map(v=>+v||0),
            penalties:(p.penalties||[]).map(v=>+v||0),
            meta: (p.meta && p.meta.length? p.meta : new Array((p.labels||[]).length).fill(META_PDN))
          };
          renderPeriodo();
        }else{
          throw results[0].reason || new Error('Falha ao carregar gráfico por período');
        }

        // DIA (opcional)
        if(results[1].status==='fulfilled' && results[1].value){
          const d = results[1].value;
          _cacheDia = {
            days:(d.days||[]).slice(),
            d07:(d.d07||[]).map(v=>+v||0),
            d16:(d.d16||[]).map(v=>+v||0),
            pen:(d.pen||[]).map(v=>+v||0)
          };
          renderDia();
        }else{
          console.warn('Gráfico por dia ficou oculto (rota PDN não disponível).');
          document.getElementById('loadingDia').classList.remove('show');
        }
      }catch(err){
        console.error(err);
        alert(err.message || 'Não foi possível carregar os dados.');
      }finally{
        setLoading(false);
      }
    }

    // ========================
    // EVENTOS
    // ========================
    btnRecarregar.addEventListener('click', carregar);

    // Período: janelas 6h / all
    btnPrevJan.addEventListener('click', ()=>{ idxJanela=(idxJanela+JANELAS.length-1)%JANELAS.length; selJanela.value=JANELAS[idxJanela].id; renderPeriodo(); });
    btnNextJan.addEventListener('click', ()=>{ idxJanela=(idxJanela+1)%JANELAS.length; selJanela.value=JANELAS[idxJanela].id; renderPeriodo(); });
    selJanela.addEventListener('change', ()=>{ const i=JANELAS.findIndex(j=>j.id===selJanela.value); idxJanela=i>=0?i:0; renderPeriodo(); });

    // Dia: modos + pager (só no "all")
    visaoDia.addEventListener('change', ()=>{ _diaPageStart=0; renderDia(); });
    btnPrevDiaOpt.addEventListener('click', ()=>{ visaoDia.selectedIndex=Math.max(0, visaoDia.selectedIndex-1); _diaPageStart=0; visaoDia.dispatchEvent(new Event('change')); });
    btnNextDiaOpt.addEventListener('click', ()=>{ visaoDia.selectedIndex=Math.min(visaoDia.options.length-1, visaoDia.selectedIndex+1); _diaPageStart=0; visaoDia.dispatchEvent(new Event    ('change')); });
    btnPrevDiaWin.addEventListener('click', ()=>{ _diaPageStart=Math.max(0, _diaPageStart-WINDOW_DIAS); renderDia(); });
    btnNextDiaWin.addEventListener('click', ()=>{ _diaPageStart=_diaPageStart+WINDOW_DIAS; renderDia(); });


    // Atualiza automaticamente ao mudar datas
   dtIni.addEventListener('change', onFiltroChange);
   dtFim.addEventListener('change', onFiltroChange);

   // Em alguns navegadores mobile o <input type="date"> dispara 'input' antes do 'change'
   dtIni.addEventListener('input', onFiltroChange);
   dtFim.addEventListener('input', onFiltroChange);

   // Se quiser que trocar período inicial/final também recarregue:
   perIni.addEventListener('change', onFiltroChange);
   perFim.addEventListener('change', onFiltroChange);



    // ========================
    // BOOT
    // ========================
    (function init(){
      initPeriodos();
      setDatasPadrao();

      // Período: abrir em "Todos"
      idxJanela = JANELAS.findIndex(j=>j.id==='all');
      initSelecaoJanela();

      // Dia: padrão "Últimos 30 dias"
      visaoDia.value = '30';

      carregar();
    })();
  </script>
</body>
</html>
