
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>DM — Gráfico Resumo (Período + Dia)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#e8fffb; --brand-dark:#0b4c59; --brand-mid:#3db7ac; --white:#fff; --text:#0b1f1e;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --br-lg:16px; --br-md:12px; --br-sm:10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    display:flex; align-items:flex-start; justify-content:center;
    padding: clamp(8px, 2vw, 16px);
  }
  .app{ width:min(900px, 100%); margin:auto; }

  .card-header{
    background:var(--brand-dark); color:#fff;
    padding: clamp(18px,5vw,28px) clamp(14px,4vw,20px);
    border-radius: var(--br-lg);
    box-shadow: var(--shadow);
    text-align:center;
  }
  .title{ margin:0; font-weight:900; letter-spacing:.4px; font-size:clamp(22px,5vw,34px) }
  .subtitle{ margin:.25rem 0 0; opacity:.9; font-weight:600; font-size:clamp(13px,3.2vw,16px) }

  .card{
    margin-top:12px; background:var(--white);
    border-radius: var(--br-lg); box-shadow: var(--shadow); overflow:hidden;
  }
  .card::before{ content:""; display:block; height:18px; background:var(--brand-mid) }
  .section-title{
    margin:12px; background:#3db7ac; color:#0b1f1e;
    font-weight:800; letter-spacing:.4px;
    padding:10px 14px; border-radius: var(--br-md);
    display:flex; align-items:center;
    font-size: clamp(12px, 2.1vw, 14px); /* títulos menores */
  }

  .filters{ display:grid; gap:10px 12px; grid-template-columns: 1fr 1fr 1fr 1fr; padding:0 12px 6px; }
  .filters .field{ display:flex; flex-direction:column; gap:6px; }
  .label{ font-weight:800; letter-spacing:.3px }
  .control{
    display:block; width:100%; min-height:44px; font-size:16px;
    padding:10px 12px; border:1px solid #cfd8dc; border-radius:var(--br-sm);
    background:#f9fafa; outline:none;
  }
  .control:focus{ border-color:var(--brand-mid); box-shadow:0 0 0 3px rgba(61,183,172,.25); background:#fff }
  input[type="date"].control{ appearance:none;-webkit-appearance:none;-moz-appearance:none }

  @media (max-width:640px){
    .filters{ grid-template-columns: 1fr 1fr; }
  }
  @media (max-width:480px){
    .filters{ grid-template-columns: 1fr; }
  }

  .chart-card{ padding: 0 12px 12px; }
  .chart-wrap{
    position: relative; width: 100%;
    height: clamp(360px, 40vh, 520px);
    border-radius: var(--br-md);
    overflow-x: auto;
    background:#fff;
  }
  .chart-wrap canvas{ min-width: 560px; display:block; }

  /* overlay de loading dentro do .chart-wrap */
  .loading {
    position:absolute; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(255,255,255,.6); backdrop-filter:saturate(1.2) blur(1px); z-index:2;
    font-weight:800; letter-spacing:.3px; border-radius: var(--br-md);
  }
  .loading.show{ display:flex; }
  .loading::before{
    content:""; width:18px; height:18px; margin-right:10px; border-radius:50%;
    border:3px solid #b9e6e1; border-top-color:var(--brand-mid); animation:spin 0.9s linear infinite;
  }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* badges de total no título */
  .totals{ display:inline-flex; gap:8px; margin-left:auto; vertical-align:middle; }
  .badge{
    display:inline-flex; gap:6px; align-items:center; padding:4px 8px; border-radius:999px;
    background:#e9fbf8; color:#0b4c59; font-weight:800; font-size:12px;
    box-shadow:0 0 0 1px rgba(61,183,172,.25) inset;
  }
  .badge .dot{ width:10px; height:10px; border-radius:50% }
  .badge.media .dot{ background:#3db7ac }
  .badge.pen  .dot{ background:#183153 }

  .actions{
    display:flex; gap:10px; justify-content:flex-end; margin:10px 12px 12px;
  }
  .btn{
    border:0; border-radius:12px; padding:12px 14px; font-weight:800; cursor:pointer;
    background:var(--brand-dark); color:#fff; box-shadow:0 6px 14px rgba(1,61,53,.18);
    transition:filter .15s ease;
  }
  .btn:hover{ filter:brightness(1.05) }
  .btn.secondary{ background:#93b8b5; color:#062f2c }
  .link-btn{
    text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    border-radius:12px; padding:12px 14px; font-weight:800; background:var(--brand-dark); color:#fff;
    box-shadow:0 6px 14px rgba(1,61,53,.18);
  }
</style>
</head>
<body>
  <main class="app">
    <header class="card-header">
      <h1 class="title">DISPONIBILIDADE EMPILHADEIRAS</h1>
      <p class="subtitle">Resumo dia + Acumulado Mês</p>
    </header>

    <!-- FILTROS -->
    <section class="card" aria-label="Filtros">
      <h2 class="section-title">FILTROS</h2>
      <div class="filters">
        <div class="field">
          <label class="label" for="dtIni">Data inicial</label>
          <input class="control" type="date" id="dtIni" />
        </div>
        <div class="field">
          <label class="label" for="dtFim">Data final</label>
          <input class="control" type="date" id="dtFim" />
        </div>
        <div class="field">
          <label class="label" for="perIni">Período inicial</label>
          <select class="control" id="perIni"></select>
        </div>
        <div class="field">
          <label class="label" for="perFim">Período final</label>
          <select class="control" id="perFim"></select>
        </div>
      </div>
      <div class="actions" style="padding:0 12px 12px">
        <button class="btn secondary" id="btnRecarregar">Recarregar</button>
        <a href="index.html" class="link-btn">Voltar ao menu</a>
      </div>
    </section>

    <!-- GRÁFICO POR PERÍODO -->
    <section class="card chart-card" aria-label="Gráfico Por Período">
      <h2 class="section-title">
        GRÁFICO POR PERÍODO
        <span class="totals">
          <span class="badge media"><span class="dot"></span><span id="tMediaPeriodo">Média: —</span></span>
          <span class="badge pen"><span class="dot"></span><span id="tPenPeriodo">Penalidade - R$: —</span></span>
        </span>
      </h2>
      <div class="chart-wrap">
        <div class="loading" id="loadingPeriodo">Carregando…</div>
        <canvas id="graficoPeriodo"></canvas>
      </div>
    </section>

    <!-- GRÁFICO POR DIA -->
    <section class="card chart-card" aria-label="Gráfico Por Dia">
      <h2 class="section-title">
        GRÁFICO POR DIA
        <span class="totals">
          <span class="badge media"><span class="dot"></span><span id="tMediaDia">Média: —</span></span>
          <span class="badge pen"><span class="dot"></span><span id="tPenDia">Penalidade - R$: —</span></span>
        </span>
      </h2>
      <div class="chart-wrap">
        <div class="loading" id="loadingDia">Carregando…</div>
        <canvas id="graficoDia"></canvas>
      </div>
    </section>

  </main>

  <!-- Chart.js + DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxe-_Yhj17NX0ze5GWo2v_W7llQD88gWIDKofhVNUrS8ShK82Hhs3nXHOwRr6nPGbknOg/exec';
    const META = 12;

    const PERIODOS = [
      "00-01h","01-02h","02-03h","03-04h","04-05h","05-06h",
      "06-07h","07-08h","08-09h","09-10h","10-11h","11-12h",
      "12-13h","13-14h","14-15h","15-16h","16-17h","17-18h",
      "18-19h","19-20h","20-21h","21-22h","22-23h","23-00h"
    ];

    function initPeriodos(){
      const perIni = document.getElementById('perIni');
      const perFim = document.getElementById('perFim');
      perIni.add(new Option('— (todos) —',''));
      perFim.add(new Option('— (todos) —',''));
      PERIODOS.forEach(p=>{
        perIni.add(new Option(p,p));
        perFim.add(new Option(p,p));
      });
      perIni.value = '';
      perFim.value = '';
    }

    function setDatasPadrao(){
      const pad = n => String(n).padStart(2,'0');
      const hoje = new Date();
      const ini = new Date(); ini.setDate(hoje.getDate());
      const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const elIni = document.getElementById('dtIni');
      const elFim = document.getElementById('dtFim');
      if (elIni && !elIni.value) elIni.value = toISO(ini);
      if (elFim && !elFim.value) elFim.value = toISO(hoje);
    }

    /* =======================
       FETCHS
       ======================= */
    async function fetchPeriodo(){
      const dtIni = document.getElementById('dtIni').value;
      const dtFim = document.getElementById('dtFim').value;
      const perIni = document.getElementById('perIni').value;
      thePerFim = document.getElementById('perFim').value;

      const params = new URLSearchParams({
        action: 'mediaDMResumo',
        dtIni, dtFim, periodoIni: perIni, periodoFim: thePerFim
      });

      const resp = await fetch(`${SCRIPT_URL}?${params.toString()}`);
      const json = await resp.json();
      if(!json.sucesso) throw new Error(json.mensagem || 'Falha ao obter dados (período)');
      return json; // {labels, values, counts, penalties}
    }

    async function fetchDia(){
      const dtIni = document.getElementById('dtIni').value;
      const dtFim = document.getElementById('dtFim').value;

      const params = new URLSearchParams({
        action: 'resumoDiarioDM',
        dtIni, dtFim
      });

      const resp = await fetch(`${SCRIPT_URL}?${params.toString()}`);
      const json = await resp.json();
      if (json && json.sucesso) return json; // {days, avg, pen}
      return { days: [], avg: [], pen: [] };
    }

    /* =======================
       UTIL / UI
       ======================= */
    function setLoading(on){
      const btn = document.getElementById('btnRecarregar');
      const lp  = document.getElementById('loadingPeriodo');
      const ld  = document.getElementById('loadingDia');
      if(on){
        btn.disabled = true; btn.textContent = 'Carregando…';
        lp.classList.add('show'); ld.classList.add('show');
      }else{
        btn.disabled = false; btn.textContent = 'Recarregar';
        lp.classList.remove('show'); ld.classList.remove('show');
      }
    }

    function setTotaisPeriodo(media, penal){
      document.getElementById('tMediaPeriodo').textContent = `Média: ${Number(media||0).toFixed(0)}`;
      document.getElementById('tPenPeriodo').textContent   = `Penalidade: R$ ${Number(penal||0).toFixed(0)}`;
    }
    function setTotaisDia(media, penal){
      document.getElementById('tMediaDia').textContent = `Média: ${Number(media||0).toFixed(0)}`;
      document.getElementById('tPenDia').textContent   = `Penalidade: R$ ${Number(penal||0).toFixed(0)}`;
    }

    function mediaSemZeros(arr){
      const v = (arr||[]).map(Number).filter(x => !isNaN(x) && x>0);
      return v.length ? v.reduce((a,b)=>a+b,0)/v.length : 0;
    }

    /* =======================
       RENDER HELPERS
       ======================= */
    function ajustarLarguraCanvas(canvasId, labels, minWDesktop=700, minWMobile=900){
      const canvas = document.getElementById(canvasId);
      const wrap   = canvas.parentElement;

      const isMobile   = window.innerWidth <= 640;
      const pxPorRotulo = isMobile ? 44 : 36;   /* garante todos rótulos visíveis */
      const minW       = isMobile ? minWMobile : minWDesktop;

      const w = Math.max(minW, labels.length * pxPorRotulo);
      const fallbackH = isMobile ? 360 : 420;
      const h = Math.max(fallbackH, wrap ? wrap.clientHeight : 0);

      canvas.width  = w;
      canvas.height = h;
      canvas.style.width  = w + 'px';
      canvas.style.height = h + 'px';
    }

    Chart.register(ChartDataLabels);

    /* =======================
       GRÁFICO POR PERÍODO
       ======================= */
    function desenharGraficoPeriodo(labels, values, counts, penalties){
      const isMobile = window.matchMedia('(max-width: 480px)').matches;
      ajustarLarguraCanvas('graficoPeriodo', labels);

      const ctx = document.getElementById('graficoPeriodo').getContext('2d');
      if (window._chartPeriodo) window._chartPeriodo.destroy();

      values    = (values||[]).map(v => +v || 0);
      counts    = (counts||[]).map(v => +v || 0);
      penalties = (penalties||[]).map(v => +v || 0);

      const baseBar   = '#3db7ac';
      const destaque  = '#0b4c59';
      const colors    = labels.map(l => l === 'Média Dia' ? destaque : baseBar);
      const isMediaDia = (c) => c.chart.data.labels[c.dataIndex] === 'Média Dia';

      const maxBar = Math.max(META + 2, Math.ceil(Math.max(...values, META) + 1));

      window._chartPeriodo = new Chart(ctx, {
        data: {
          labels,
          _counts: counts,
          datasets: [
            {
              type: 'bar',
              label: 'Média Empilhadeiras',
              yAxisID: 'y',
              data: values,
              backgroundColor: colors,
              borderColor: colors,
              borderWidth: 1,
              maxBarThickness: isMobile ? 22 : 28,
              categoryPercentage: isMobile ? 0.78 : 0.82,
              barPercentage:       isMobile ? 0.78 : 0.82,
              datalabels: {
                display: (c) => c.datasetIndex === 0,
                color:   (c) => isMediaDia(c) ? '#fff' : '#083735',
                anchor:  'center',
                align:   'center',
                offset:  (c) => isMediaDia(c) ? 0 : -4,
                clamp: true,
                formatter: (v) => Math.round(v),
                font: { weight: 800, size: isMobile ? 8 : 14 }
              }
            },
            {
              type: 'line',
              label: `Meta ${META}`,
              yAxisID: 'y',
              data: new Array(labels.length).fill(META),
              borderColor: 'red',
              borderWidth: 2,
              borderDash: [4,3],
              pointRadius: 0,
              fill: false,
              datalabels: { display: false }
            },
            {
              type: 'line',
              label: 'Penalidades (Σ)',
              yAxisID: 'y1',
              data: penalties,
              borderColor: '#183153',
              backgroundColor: '#183153',
              borderWidth: 2,
              tension: 0.25,
              pointRadius: 3,
              pointHoverRadius: 4,
              datalabels: {
                display: true,
                color: '#183153',
                anchor: 'end',
                align: 'top',
                rotation: -90,
                offset: 2,
                formatter: (v) => `R$ ${Math.round(v)}`,
                font: { weight: 800, size: isMobile ? 8 : 10 }
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { usePointStyle: true, pointStyle: 'rectRounded', boxWidth: 10, boxHeight: 10, font:{size:isMobile?11:14} }
            },
            tooltip: {
              callbacks: {
                label: (c) => {
                  if (c.dataset.yAxisID === 'y1') return ` Penalidades: ${c.parsed.y}`;
                  if (c.dataset.type === 'line')   return `${c.dataset.label}`;
                  return ` Média: ${c.parsed.y}`;
                },
                afterLabel: (c) => {
                  if (c.dataset.yAxisID === 'y1') return '';
                  const q = (c.chart.data._counts || [])[c.dataIndex] || 0;
                  return q ? ` Registros: ${q}` : '';
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                autoSkip: false,
                maxRotation: isMobile ? 90 : 45,
                minRotation: isMobile ? 90 : 45,
                font: { size: isMobile ? 8 : 11 },
                callback: function(value){ return this.getLabelForValue(value); }
              },
              grid: { display: false }
            },
            y: {
              beginAtZero: true, display:false,
              suggestedMax: maxBar,
              min: 0,
              max: 20,
              title: { display: true, text: 'Média' },
              ticks: { precision: 0 }
            },
            y1: {
              position: 'right', display:false,
              min: -190000,
              max:  70000,
              grid: { drawOnChartArea: false },
              title: { display: false, text: 'Penalidades (Σ)' },
              ticks: { precision: 0 }
            }
          },
          layout: { padding: { top: 6, right: 10, bottom: isMobile ? 64 : 52, left: 6 } }
        }
      });

      window._chartPeriodo.options.scales.x.ticks.minRotation = 90;
      window._chartPeriodo.options.scales.x.ticks.maxRotation = 90;
      window._chartPeriodo.options.scales.x.ticks.autoSkip   = false;
      window._chartPeriodo.update();
    }

    /* =======================
       GRÁFICO POR DIA
       ======================= */
    function desenharGraficoDia(labelsDias, mediasDia, penalDia){
      const isMobile = window.matchMedia('(max-width: 480px)').matches;
      ajustarLarguraCanvas('graficoDia', labelsDias, 800, 900);

      const ctx = document.getElementById('graficoDia').getContext('2d');
      if (window._chartDia) window._chartDia.destroy();

      mediasDia = (mediasDia||[]).map(v => +v || 0);
      penalDia  = (penalDia ||[]).map(v => +v || 0);

      const baseBar   = '#3db7ac';
      const destaque  = '#0b4c59';
      const isMedia = (lbl, i) => lbl === 'Média' || i === labelsDias.length - 1;
      const colorsDia = labelsDias.map((lbl, i) => isMedia(lbl, i) ? destaque : baseBar);

      const maxBar = Math.max(META + 2, Math.ceil(Math.max(...mediasDia, META) + 1));

      window._chartDia = new Chart(ctx, {
        data: {
          labels: labelsDias,
          datasets: [
            {
              type: 'bar',
              label: 'Média Empilhadeiras (dia)',
              yAxisID: 'y',
              data: mediasDia,
              backgroundColor: colorsDia,
              borderColor: colorsDia,
              borderWidth: 1,
              maxBarThickness: isMobile ? 22 : 28,
              datalabels: {
                display: true,
                color: (c) => {
                  const i = c.dataIndex, lbl = c.chart.data.labels[i];
                  return (lbl === 'Média' || i === c.chart.data.labels.length -1) ? '#fff' : '#083735';
                },
                anchor:'center', align:'center', offset:0,
                formatter: (v)=>Math.round(v),
                font:{weight:800, size:isMobile?8:14}
              }
            },
            {
              type: 'line',
              label: `Meta ${META}`,
              yAxisID: 'y',
              data: new Array(labelsDias.length).fill(META),
              borderColor: 'red',
              borderWidth: 2,
              borderDash: [4,3],
              pointRadius: 0,
              fill: false,
              datalabels: { display:false }
            },
            {
              type: 'line',
              label: 'Penalidades (Σ)',
              yAxisID: 'y1',
              data: penalDia,
              borderColor: '#183153',
              backgroundColor: '#183153',
              borderWidth: 2,
              tension: 0.25,
              pointRadius: 3,
              pointHoverRadius: 4,
              datalabels: {
                display:true,
                color:'#183153',
                anchor:'end', align:'top', offset:2,
                rotation: -90,
                formatter: (v) => `R$ ${Math.round(v)}`,
                font:{weight:800, size:isMobile?8:10}
              }
            }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ display:true, position:'top',
              labels:{ usePointStyle:true, pointStyle:'rectRounded', boxWidth:10, boxHeight:10, font:{size:isMobile?11:14} }
            },
            tooltip:{
              callbacks:{
                label:(c)=>{
                  if (c.dataset.yAxisID==='y1') return ` Penalidades: ${c.parsed.y}`;
                  if (c.dataset.type==='line') return `${c.dataset.label}`;
                  return ` Média: ${c.parsed.y}`;
                }
              }
            }
          },
          scales:{
            x:{
              ticks:{
                autoSkip:false,
                maxRotation:isMobile?60:0,
                minRotation:isMobile?60:0,
                font:{ size:isMobile?9:11 }
              },
              grid:{ display:false }
            },
            y:{
              beginAtZero:true, display:false,
              min: 0,
              max: 20,
              suggestedMax:maxBar,
              title:{ display:true, text:'Média' },
              ticks:{ precision:0 }
            },
            y1:{
              position:'right', display:false,
              min: -190000,
              max:  70000,
              grid:{ drawOnChartArea:false },
              title:{ display:false, text:'Penalidades (Σ)' },
              ticks:{ precision:0 }
            }
          },
          layout:{ padding:{ top:6, right:10, bottom:isMobile?64:44, left:6 } }
        }
      });
    }

    /* =======================
       CARREGAR TUDO
       ======================= */
    async function carregar(){
      setLoading(true);
      try{
        const [p, d] = await Promise.all([ fetchPeriodo(), fetchDia() ]);

        // ===== PERÍODO =====
        const labelsP = (p.labels || []).slice();
        const valuesP = (p.values || []).map(v=>+v||0);
        const countsP = (p.counts || []).map(v=>+v||0);
        const pensP   = (p.penalties || []).map(v=>+v||0);

        // Se o backend não mandar "Média Dia" (hoje manda), acrescenta no front
        if (!labelsP.includes('Média Dia')) {
          labelsP.push('Média Dia');
          valuesP.push(+mediaSemZeros(valuesP).toFixed(2));
          countsP.push(valuesP.filter(v=>v>0).length);
          pensP.push(pensP.reduce((a,b)=>a+b,0));
        }
        desenharGraficoPeriodo(labelsP, valuesP, countsP, pensP);
        setTotaisPeriodo(valuesP[valuesP.length-1], pensP[pensP.length-1]);

        // ===== DIA =====
        const diasISO = d.days || [];
        let mediasDia = (d.avg || []).map(v => +v || 0);
        let penalDia  = (d.pen || []).map(v => +v || 0);

        // Converte YYYY-MM-DD -> DD/MM
        const diasBr = diasISO.map(s=>{
          const m = String(s||'').match(/^(\d{4})-(\d{2})-(\d{2})/);
          return m ? `${m[3]}/${m[2]}` : s;
        });

        // Se backend mandou "Média Dias", renomeia para "Média"; se não mandou, adiciona
        if (diasBr.length && (diasBr[diasBr.length-1] === 'Média Dias' || diasBr[diasBr.length-1] === 'Média')) {
          diasBr[diasBr.length-1] = 'Média';
        } else {
          const mediaTotal = +mediaSemZeros(mediasDia).toFixed(2);
          const penTotal   = penalDia.reduce((a,b)=>a+b,0);
          diasBr.push('Média');
          mediasDia.push(mediaTotal);
          penalDia.push(penTotal);
        }

        desenharGraficoDia(diasBr, mediasDia, penalDia);

        // totalizadores (usa último ponto)
        const mediaUlt = mediasDia[mediasDia.length-1] || 0;
        const penUlt   = penalDia[penalDia.length-1]   || 0;
        setTotaisDia(mediaUlt, penUlt);

      }catch(err){
        console.error(err);
        alert('Não foi possível carregar os dados.');
      }finally{
        setLoading(false);
      }
    }

    document.getElementById('btnRecarregar').addEventListener('click', carregar);

    // init
    initPeriodos();
    setDatasPadrao();
    carregar();
  </script>
</body>
</html>
